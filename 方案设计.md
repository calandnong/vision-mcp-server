# Vision MCP Server æ”¹é€ æ–¹æ¡ˆè®¾è®¡

## ä¸€ã€é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é¡¹ç›®æ¦‚è¿°
æœ¬æ–¹æ¡ˆåŸºäº code-rag/mcp-server é¡¹ç›®ï¼Œè¿›è¡ŒåŠŸèƒ½è£å‰ªå’Œæ¥å£æ”¹é€ ï¼Œç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªä¸“æ³¨äºå›¾åƒåˆ†æèƒ½åŠ›çš„ MCP Serverï¼Œå»é™¤è§†é¢‘åŠŸèƒ½ï¼Œå¹¶å°†æ™ºè°± API æ¥å£æ”¹é€ ä¸º OpenAI API æ ¼å¼ã€‚

### 1.2 æ”¹é€ ç›®æ ‡
- âœ… **å»é™¤è§†é¢‘åŠŸèƒ½**: ç§»é™¤æ‰€æœ‰è§†é¢‘ç›¸å…³çš„å·¥å…·ã€æ–‡ä»¶å¤„ç†å’Œ API è°ƒç”¨
- âœ… **æ¥å£æ”¹é€ **: å°†æ™ºè°± API æ ¼å¼æ”¹é€ ä¸ºæ ‡å‡†çš„ OpenAI API æ ¼å¼
- âœ… **ä¿æŒæ¶æ„**: ä¿æŒåŸæœ‰çš„ä¼˜ç§€æ¶æ„è®¾è®¡å’Œä»£ç è´¨é‡
- âœ… **ç®€åŒ–é…ç½®**: ç®€åŒ–ç¯å¢ƒå˜é‡é…ç½®ï¼Œåªä¿ç•™å¿…è¦çš„é…ç½®é¡¹

### 1.3 æ”¹é€ èŒƒå›´

#### åŠŸèƒ½è£å‰ª
- âŒ ç§»é™¤ `video-analysis.js` å·¥å…·
- âŒ ç§»é™¤ `FileService` ä¸­çš„è§†é¢‘ç›¸å…³æ–¹æ³•
- âŒ ç§»é™¤ `createVideoContent()` API å‡½æ•°
- âŒ ç§»é™¤è§†é¢‘ç›¸å…³çš„æç¤ºè¯
- âœ… ä¿ç•™ 7 ä¸ªå›¾åƒåˆ†æå·¥å…·

#### æ¥å£æ”¹é€ 
- ğŸ”§ æ”¹é€  `ChatService` ä½¿ç”¨ OpenAI API æ ¼å¼
- ğŸ”§ æ”¹é€  `EnvironmentService` çš„é…ç½®é¡¹
- ğŸ”§ æ”¹é€ è¯·æ±‚å’Œå“åº”æ ¼å¼
- ğŸ”§ ç§»é™¤æ™ºè°±ç‰¹å®šçš„è¯·æ±‚å¤´å’Œå‚æ•°

---

## äºŒã€åŸæ¶æ„æ·±åº¦åˆ†æ

### 2.1 é¡¹ç›®ç»“æ„

```
code-rag/mcp-server/
â”œâ”€â”€ package.json                      # npm åŒ…é…ç½®
â”œâ”€â”€ README.zh-CN.md                   # ä¸­æ–‡æ–‡æ¡£
â”œâ”€â”€ build/                            # ç¼–è¯‘åçš„æºä»£ç 
    â”œâ”€â”€ index.js                      # 127 è¡Œ - MCP Server å…¥å£
    â”œâ”€â”€ core/                         # æ ¸å¿ƒæœåŠ¡å±‚
    â”‚   â”œâ”€â”€ api-common.js             # 122 è¡Œ - API å…¬å…±å‡½æ•°
    â”‚   â”œâ”€â”€ base-image-service.js     # 91 è¡Œ - å›¾åƒåˆ†æåŸºç±»
    â”‚   â”œâ”€â”€ chat-service.js           # 94 è¡Œ - æ™ºè°± API èŠå¤©æœåŠ¡ âš ï¸ éœ€æ”¹é€ 
    â”‚   â”œâ”€â”€ environment.js            # 128 è¡Œ - ç¯å¢ƒé…ç½®æœåŠ¡ âš ï¸ éœ€æ”¹é€ 
    â”‚   â”œâ”€â”€ error-handler.js          # 376 è¡Œ - é”™è¯¯å¤„ç†ç³»ç»Ÿ
    â”‚   â””â”€â”€ file-service.js           # 126 è¡Œ - æ–‡ä»¶æ“ä½œæœåŠ¡ âš ï¸ éœ€æ”¹é€ 
    â”œâ”€â”€ tools/                        # MCP å·¥å…·å®ç°
    â”‚   â”œâ”€â”€ ui-to-artifact.js         # UI è½¬ä»£ç å·¥å…·
    â”‚   â”œâ”€â”€ text-extraction.js        # æ–‡å­—æå–å·¥å…·
    â”‚   â”œâ”€â”€ error-diagnosis.js        # é”™è¯¯è¯Šæ–­å·¥å…·
    â”‚   â”œâ”€â”€ diagram-analysis.js       # å›¾è¡¨åˆ†æå·¥å…·
    â”‚   â”œâ”€â”€ data-viz.js               # æ•°æ®å¯è§†åŒ–åˆ†æå·¥å…·
    â”‚   â”œâ”€â”€ ui-diff.js                # UI å·®å¼‚æ£€æŸ¥å·¥å…·
    â”‚   â”œâ”€â”€ general-image.js          # é€šç”¨å›¾åƒåˆ†æå·¥å…·
    â”‚   â””â”€â”€ video-analysis.js         # è§†é¢‘åˆ†æå·¥å…· âŒ éœ€åˆ é™¤
    â”œâ”€â”€ prompts/                      # AI æç¤ºè¯æ¨¡æ¿
    â”‚   â”œâ”€â”€ index.js
    â”‚   â”œâ”€â”€ ui-to-artifact.js
    â”‚   â”œâ”€â”€ text-extraction.js
    â”‚   â”œâ”€â”€ error-diagnosis.js
    â”‚   â”œâ”€â”€ diagram-analysis.js
    â”‚   â”œâ”€â”€ data-viz.js
    â”‚   â”œâ”€â”€ ui-diff.js
    â”‚   â””â”€â”€ general-image.js
    â”œâ”€â”€ types/                        # ç±»å‹å®šä¹‰
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ validation-types.js
    â””â”€â”€ utils/                        # å·¥å…·å‡½æ•°
        â”œâ”€â”€ logger.js                 # æ—¥å¿—ç³»ç»Ÿ
        â””â”€â”€ validation.js             # å‚æ•°éªŒè¯
```

### 2.2 æ ¸å¿ƒæœåŠ¡åˆ†æ

#### 2.2.1 ChatService (æ™ºè°± API é›†æˆ)

**æ–‡ä»¶**: `build/core/chat-service.js`

**å½“å‰å®ç°**:
```javascript
async visionCompletions(messages) {
    const visionConfig = configurationService.getVisionConfig();
    const requestBody = {
        model: visionConfig.model,              // glm-4.6v
        messages,
        thinking: { type: 'enabled' },          // âš ï¸ æ™ºè°±ç‰¹æœ‰
        stream: false,
        temperature: visionConfig.temperature,
        top_p: visionConfig.topP,
        max_tokens: visionConfig.maxTokens
    };

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'X-Title': '4.5V MCP Local',        // âš ï¸ æ™ºè°±ç‰¹æœ‰
            'Accept-Language': 'en-US,en'
        },
        body: JSON.stringify(body)
    });

    const result = response.choices?.[0]?.message?.content;
    return result;
}
```

**é—®é¢˜åˆ†æ**:
1. `thinking` å‚æ•°æ˜¯æ™ºè°±ç‰¹æœ‰çš„ï¼ŒOpenAI ä¸æ”¯æŒ
2. `X-Title` è¯·æ±‚å¤´æ˜¯æ™ºè°±ç‰¹æœ‰çš„
3. å“åº”æ ¼å¼è™½ç„¶å…¼å®¹ï¼Œä½†éœ€è¦ç¡®è®¤å®Œæ•´å…¼å®¹æ€§

#### 2.2.2 EnvironmentService (é…ç½®ç®¡ç†)

**æ–‡ä»¶**: `build/core/environment.js`

**å½“å‰é…ç½®é¡¹**:
```javascript
{
    Z_AI_BASE_URL: "https://open.bigmodel.cn/api/paas/v4/",  // âš ï¸ æ™ºè°±åœ°å€
    Z_AI_API_KEY: string,
    Z_AI_VISION_MODEL: "glm-4.6v",                            // âš ï¸ æ™ºè°±æ¨¡å‹
    Z_AI_VISION_MODEL_TEMPERATURE: 0.8,
    Z_AI_VISION_MODEL_TOP_P: 0.6,
    Z_AI_VISION_MODEL_MAX_TOKENS: 32768,
    Z_AI_TIMEOUT: 300000,
    Z_AI_RETRY_COUNT: 1,
    SERVER_NAME: "zai-mcp-server",
    SERVER_VERSION: "0.1.2",
    PLATFORM_MODE: "ZHIPU" | "ZAI"                            // âš ï¸ æ™ºè°±å¹³å°
}
```

**é—®é¢˜åˆ†æ**:
1. å¹³å°æ¨¡å¼é€‰æ‹©é€»è¾‘è¿‡äºå¤æ‚
2. å¤šä¸ªå…¼å®¹æ€§ç¯å¢ƒå˜é‡ï¼ˆZAI_API_KEY, ANTHROPIC_AUTH_TOKENï¼‰å¯¼è‡´æ··æ·†
3. é»˜è®¤é…ç½®æŒ‡å‘æ™ºè°±å¹³å°

#### 2.2.3 FileService (æ–‡ä»¶æ“ä½œ)

**æ–‡ä»¶**: `build/core/file-service.js`

**è§†é¢‘ç›¸å…³æ–¹æ³•** (éœ€è¦åˆ é™¤):
```javascript
// ç¬¬ 48-60 è¡Œ
async validateVideoSource(videoSource, maxSizeMB = 8) { ... }

// ç¬¬ 83-94 è¡Œ
async encodeVideoToBase64(videoSource) { ... }

// ç¬¬ 111-121 è¡Œ
static getVideoMimeType(extension) { ... }
```

**å›¾åƒç›¸å…³æ–¹æ³•** (ä¿ç•™):
```javascript
async validateImageSource(imageSource, maxSizeMB = 5)
async encodeImageToBase64(imageSource)
static getMimeType(extension)
```

#### 2.2.4 ApiCommon (API å…¬å…±å‡½æ•°)

**æ–‡ä»¶**: `build/core/api-common.js`

**è§†é¢‘å†…å®¹åˆ›å»º** (éœ€è¦åˆ é™¤):
```javascript
// ç¬¬ 36-45 è¡Œ
export function createVideoContent(videoUrl) {
    return {
        type: 'video_url',
        video_url: { url: videoUrl }
    };
}
```

**å›¾åƒå†…å®¹åˆ›å»º** (ä¿ç•™):
```javascript
export function createImageContent(imageUrl) {
    return {
        type: 'image_url',
        image_url: { url: imageUrl }
    };
}
```

### 2.3 å·¥å…·å±‚åˆ†æ

#### 2.3.1 è§†é¢‘å·¥å…· (éœ€è¦åˆ é™¤)

**æ–‡ä»¶**: `build/tools/video-analysis.js` (134 è¡Œ)

**ä¸»è¦ç±»**: `VideoAnalysisService`

**æ ¸å¿ƒæ–¹æ³•**:
```javascript
async analyzeVideo(request) {
    // 1. éªŒè¯è§†é¢‘æº (æ–‡ä»¶å­˜åœ¨æ€§ã€å¤§å°é™åˆ¶ 8MB)
    await this.fileService.validateVideoSource(request.videoSource, 8);

    // 2. åˆ¤æ–­æ˜¯ URL è¿˜æ˜¯æœ¬åœ°æ–‡ä»¶
    // 3. Base64 ç¼–ç  (data:video/mp4;base64,...)
    const videoData = await this.fileService.encodeVideoToBase64(request.videoSource);

    // 4. åˆ›å»ºå¤šæ¨¡æ€æ¶ˆæ¯
    const messages = createMultiModalMessage([videoContent], request.prompt);

    // 5. è°ƒç”¨æ™ºè°± API è¿›è¡Œè§†é¢‘åˆ†æ
    const result = await this.chatService.visionCompletions(messages);

    return result;
}
```

**æ³¨å†Œæ–¹å¼**:
```javascript
// index.js ç¬¬ 17 è¡Œ
import { registerVideoAnalysisTool } from './tools/video-analysis.js';

// index.js ç¬¬ 50 è¡Œ
registerVideoAnalysisTool(this.server);
```

#### 2.3.2 å›¾åƒå·¥å…· (å…¨éƒ¨ä¿ç•™)

æ‰€æœ‰ 7 ä¸ªå›¾åƒå·¥å…·éƒ½ç»§æ‰¿è‡ª `BaseImageAnalysisService`ï¼Œä¸éœ€è¦ä¿®æ”¹ï¼š

1. **ui-to-artifact.js** - UI è½¬ä»£ç å·¥å…· (91 è¡Œ)
2. **text-extraction.js** - OCR æ–‡å­—æå–å·¥å…· (87 è¡Œ)
3. **error-diagnosis.js** - é”™è¯¯è¯Šæ–­å·¥å…· (87 è¡Œ)
4. **diagram-analysis.js** - å›¾è¡¨åˆ†æå·¥å…· (87 è¡Œ)
5. **data-viz.js** - æ•°æ®å¯è§†åŒ–åˆ†æå·¥å…· (87 è¡Œ)
6. **ui-diff.js** - UI å·®å¼‚æ£€æŸ¥å·¥å…· (92 è¡Œ)
7. **general-image.js** - é€šç”¨å›¾åƒåˆ†æå·¥å…· (78 è¡Œ)

---

## ä¸‰ã€OpenAI API æ¥å£è®¾è®¡

### 3.1 OpenAI Chat Completions API æ ‡å‡†

**å®˜æ–¹æ–‡æ¡£**: https://platform.openai.com/docs/api-reference/chat/create

**è¯·æ±‚æ ¼å¼**:
```json
POST https://api.openai.com/v1/chat/completions
Authorization: Bearer YOUR_API_KEY
Content-Type: application/json

{
  "model": "gpt-4o",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "What's in this image?"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "https://example.com/image.jpg"
          }
        }
      ]
    }
  ],
  "temperature": 0.8,
  "top_p": 0.6,
  "max_tokens": 32768,
  "stream": false
}
```

**å“åº”æ ¼å¼**:
```json
{
  "id": "chatcmpl-abc123",
  "object": "chat.completion",
  "created": 1699017642,
  "model": "gpt-4o",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "This image contains..."
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 100,
    "completion_tokens": 50,
    "total_tokens": 150
  }
}
```

### 3.2 æ”¯æŒçš„è§†è§‰æ¨¡å‹

| æ¨¡å‹åç§° | èƒ½åŠ› | ä¸Šä¸‹æ–‡ | å›¾åƒæ”¯æŒ |
|---------|------|--------|---------|
| gpt-4o | æœ€æ–°çš„å¤šæ¨¡æ€æ¨¡å‹ | 128K | âœ… |
| gpt-4o-mini | è½»é‡çº§å¤šæ¨¡æ€ | 128K | âœ… |
| gpt-4-turbo | é«˜æ€§èƒ½å¤šæ¨¡æ€ | 128K | âœ… |
| gpt-4-vision-preview | è§†è§‰é¢„è§ˆç‰ˆ | 128K | âœ… |

**æ¨èé…ç½®**:
- é»˜è®¤æ¨¡å‹: `gpt-4o` (æœ€æ–°æœ€å¼º)
- å¤‡é€‰æ¨¡å‹: `gpt-4o-mini` (æ›´ä¾¿å®œ)
- ä¸Šä¸‹æ–‡é•¿åº¦: 128K tokens
- æœ€å¤§å›¾åƒå¤§å°: 20MB (OpenAI é™åˆ¶)

---

## å››ã€è¯¦ç»†æ”¹é€ æ–¹æ¡ˆ

### 4.1 ç¯å¢ƒå˜é‡é…ç½®æ”¹é€ 

#### 4.1.1 æ–°çš„ç¯å¢ƒå˜é‡è®¾è®¡

```javascript
// build/core/environment.js
{
    // OpenAI é…ç½®
    OPENAI_API_KEY: string,           // å¿…éœ€: OpenAI API Key
    OPENAI_BASE_URL: string,          // å¯é€‰: è‡ªå®šä¹‰ Base URL (é»˜è®¤: https://api.openai.com/v1)
    OPENAI_VISION_MODEL: string,      // å¯é€‰: è§†è§‰æ¨¡å‹åç§° (é»˜è®¤: gpt-4o)

    // æ¨¡å‹å‚æ•°
    OPENAI_MODEL_TEMPERATURE: number, // å¯é€‰: æ¸©åº¦ (é»˜è®¤: 0.8)
    OPENAI_MODEL_TOP_P: number,       // å¯é€‰: Top P (é»˜è®¤: 0.6)
    OPENAI_MODEL_MAX_TOKENS: number,  // å¯é€‰: æœ€å¤§ tokens (é»˜è®¤: 32768)

    // è¯·æ±‚é…ç½®
    OPENAI_TIMEOUT: number,          // å¯é€‰: è¶…æ—¶æ—¶é—´ ms (é»˜è®¤: 300000)
    OPENAI_RETRY_COUNT: number,      // å¯é€‰: é‡è¯•æ¬¡æ•° (é»˜è®¤: 1)

    // æœåŠ¡å™¨é…ç½®
    SERVER_NAME: string,             // å¯é€‰: æœåŠ¡å™¨åç§° (é»˜è®¤: vision-mcp-server)
    SERVER_VERSION: string           // å¯é€‰: æœåŠ¡å™¨ç‰ˆæœ¬ (é»˜è®¤: 0.1.2)
}
```

#### 4.1.2 é…ç½®åŠ è½½é€»è¾‘

**æ”¹é€ åçš„ `loadEnvironmentConfig()` æ–¹æ³•**:

```javascript
loadEnvironmentConfig() {
    const envConfig = { ...process.env };

    // 1. éªŒè¯å¿…éœ€çš„ API Key
    if (!envConfig.OPENAI_API_KEY || envConfig.OPENAI_API_KEY.trim().length === 0) {
        throw new ApiError('OPENAI_API_KEY environment variable is required');
    }

    // 2. æ£€æµ‹å ä½ç¬¦
    const apiKey = envConfig.OPENAI_API_KEY;
    if (apiKey.toLowerCase().includes('your_') ||
        apiKey.toLowerCase().includes('api_key') ||
        apiKey.toLowerCase().includes('sk-')) {
        throw new ApiError('OPENAI_API_KEY appears to be a placeholder. Please set your actual API key.');
    }

    // 3. è®¾ç½®é»˜è®¤å€¼
    return {
        OPENAI_API_KEY: apiKey,
        OPENAI_BASE_URL: envConfig.OPENAI_BASE_URL || 'https://api.openai.com/v1',
        OPENAI_VISION_MODEL: envConfig.OPENAI_VISION_MODEL || 'gpt-4o',
        OPENAI_MODEL_TEMPERATURE: parseFloat(envConfig.OPENAI_MODEL_TEMPERATURE || '0.8'),
        OPENAI_MODEL_TOP_P: parseFloat(envConfig.OPENAI_MODEL_TOP_P || '0.6'),
        OPENAI_MODEL_MAX_TOKENS: parseInt(envConfig.OPENAI_MODEL_MAX_TOKENS || '32768'),
        OPENAI_TIMEOUT: parseInt(envConfig.OPENAI_TIMEOUT || '300000'),
        OPENAI_RETRY_COUNT: parseInt(envConfig.OPENAI_RETRY_COUNT || '1'),
        SERVER_NAME: envConfig.SERVER_NAME || 'vision-mcp-server',
        SERVER_VERSION: envConfig.SERVER_VERSION || '0.1.2'
    };
}
```

**æ”¹é€ åçš„ `getVisionConfig()` æ–¹æ³•**:

```javascript
getVisionConfig() {
    const config = this.getConfig();
    return {
        model: config.OPENAI_VISION_MODEL,
        timeout: config.OPENAI_TIMEOUT,
        retryCount: config.OPENAI_RETRY_COUNT,
        url: config.OPENAI_BASE_URL + '/chat/completions',
        temperature: config.OPENAI_MODEL_TEMPERATURE,
        topP: config.OPENAI_MODEL_TOP_P,
        maxTokens: config.OPENAI_MODEL_MAX_TOKENS
    };
}
```

#### 4.1.3 ç§»é™¤çš„æ–¹æ³•

```javascript
// âŒ åˆ é™¤: ä¸å†éœ€è¦å¹³å°æ¨¡å¼é€‰æ‹©
getPlatformModel() { ... }

// âŒ åˆ é™¤: ä¸å†éœ€è¦å…¼å®¹æ™ºè°±çš„å¤šä¸ª API Key
loadEnvironmentConfig() ä¸­çš„æ™ºè°±å…¼å®¹é€»è¾‘
```

### 4.2 ChatService æ”¹é€ 

#### 4.2.1 æ”¹é€ åçš„ `visionCompletions()` æ–¹æ³•

```javascript
async visionCompletions(messages) {
    const visionConfig = configurationService.getVisionConfig();
    const apiKey = this.environmentService.getApiKey();

    // OpenAI æ ‡å‡†è¯·æ±‚æ ¼å¼
    const requestBody = {
        model: visionConfig.model,
        messages,
        temperature: visionConfig.temperature,
        top_p: visionConfig.topP,
        max_tokens: visionConfig.maxTokens,
        stream: false
    };

    console.info('Requesting OpenAI chat completions API for vision analysis', {
        model: visionConfig.model,
        messageCount: messages.length
    });

    try {
        const response = await this.chatCompletions(visionConfig.url, requestBody, apiKey);
        const result = response.choices?.[0]?.message?.content;

        if (!result) {
            throw new ApiError('Invalid API response: missing content');
        }

        console.info('OpenAI chat completions API request successful');
        return result;
    } catch (error) {
        console.error('OpenAI chat completions API request failed', {
            error: error instanceof Error ? error.message : String(error)
        });
        throw error instanceof ApiError ? error : new ApiError(`API call failed: ${error}`);
    }
}
```

#### 4.2.2 æ”¹é€ åçš„ `chatCompletions()` æ–¹æ³•

```javascript
async chatCompletions(url, body, apiKey) {
    const apiConfig = configurationService.getVisionConfig();
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), apiConfig.timeout);

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(body),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorText = await response.text();
            throw new ApiError(`HTTP ${response.status}: ${errorText}`);
        }

        return await response.json();
    } catch (error) {
        clearTimeout(timeoutId);

        if (error instanceof ApiError) {
            throw error;
        }

        if (error instanceof Error) {
            if (error.name === 'AbortError') {
                throw new ApiError(`Request timeout after ${apiConfig.timeout}ms when calling ${url}`);
            }

            if (error.message.includes('fetch failed')) {
                const causeInfo = error.cause ? ` | Cause: ${error.cause}` : '';
                throw new ApiError(
                    `Network error: Failed to connect to ${url}. ` +
                    `Original error: ${error.message}${causeInfo}`
                );
            }

            throw new ApiError(`Network error: ${error.message}`);
        }

        throw new ApiError(`Network error: ${String(error)}`);
    }
}
```

**æ”¹é€ è¦ç‚¹**:
1. âœ… ç§»é™¤ `thinking: { type: 'enabled' }` å‚æ•°
2. âœ… ç§»é™¤ `X-Title` è¯·æ±‚å¤´
3. âœ… ä½¿ç”¨æ ‡å‡†çš„ Authorization å¤´
4. âœ… æ·»åŠ  `Accept: application/json` å¤´
5. âœ… ç®€åŒ–é”™è¯¯å¤„ç†é€»è¾‘
6. âœ… å“åº”æ ¼å¼ä¿æŒä¸å˜ï¼ˆå…¼å®¹ï¼‰

### 4.3 FileService æ”¹é€ 

#### 4.3.1 åˆ é™¤è§†é¢‘ç›¸å…³æ–¹æ³•

```javascript
// âŒ åˆ é™¤ç¬¬ 48-60 è¡Œ: validateVideoSource()
// âŒ åˆ é™¤ç¬¬ 83-94 è¡Œ: encodeVideoToBase64()
// âŒ åˆ é™¤ç¬¬ 111-121 è¡Œ: getVideoMimeType()
```

#### 4.3.2 ä¿ç•™çš„æ–¹æ³•ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

```javascript
// âœ… ä¿ç•™: å›¾åƒéªŒè¯
async validateImageSource(imageSource, maxSizeMB = 5) {
    if (this.isUrl(imageSource)) {
        return;
    }

    if (!fs.existsSync(imageSource)) {
        throw new FileNotFoundError(`Image file not found: ${imageSource}`);
    }

    const stats = fs.statSync(imageSource);
    const maxSizeBytes = maxSizeMB * 1024 * 1024;

    if (stats.size > maxSizeBytes) {
        throw new ValidationError(
            `Image file too large: ${(stats.size / (1024 * 1024)).toFixed(2)}MB. ` +
            `Maximum allowed: ${maxSizeMB}MB`
        );
    }

    const ext = path.extname(imageSource).toLowerCase();
    const supportedExts = ['.jpg', '.jpeg', '.png'];

    if (!supportedExts.includes(ext)) {
        throw new ValidationError(
            `Unsupported image format: ${ext}. Supported formats: ${supportedExts.join(', ')}`
        );
    }
}

// âœ… ä¿ç•™: å›¾åƒç¼–ç 
async encodeImageToBase64(imageSource) {
    if (this.isUrl(imageSource)) {
        return imageSource;
    }

    const imageBuffer = fs.readFileSync(imageSource);
    const ext = path.extname(imageSource).toLowerCase().slice(1);
    const mimeType = this.getMimeType(ext);

    console.debug('Encoded image to base64', { imageSource, mimeType });
    return `data:${mimeType};base64,${imageBuffer.toString('base64')}`;
}

// âœ… ä¿ç•™: MIME ç±»å‹è·å–
static getMimeType(extension) {
    const mimeTypes = {
        png: 'image/png',
        jpg: 'image/jpeg',
        jpeg: 'image/jpeg'
    };
    return mimeTypes[extension] || 'image/png';
}

// âœ… ä¿ç•™: URL åˆ¤æ–­
static isUrl(source) {
    try {
        const url = new URL(source);
        return url.protocol === 'http:' || url.protocol === 'https:';
    } catch {
        return false;
    }
}
```

#### 4.3.3 åœ¨çº¿é“¾æ¥å¤„ç†ä¼˜åŒ–

**é—®é¢˜åˆ†æ**:
å½“å‰å®ç°ç›´æ¥ä¼ é€’åœ¨çº¿é“¾æ¥ç»™ OpenAI APIï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. OpenAI æœåŠ¡å™¨å¯èƒ½æ— æ³•è®¿é—®å†…ç½‘ã€ç§æœ‰äº‘æˆ–éœ€è¦è®¤è¯çš„å›¾ç‰‡é“¾æ¥
2. å›¾ç‰‡é“¾æ¥å¯èƒ½è¿‡æœŸæˆ–è¢«åˆ é™¤ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥
3. æ— æ³•é¢„å¤„ç†å›¾ç‰‡ï¼ˆå‹ç¼©ã€æ ¼å¼è½¬æ¢ã€å°ºå¯¸ä¼˜åŒ–ï¼‰
4. å¤±è´¥æ’æŸ¥å›°éš¾ï¼Œæ— æ³•ç¡®å®šæ˜¯å›¾ç‰‡é—®é¢˜è¿˜æ˜¯ç½‘ç»œé—®é¢˜

**ä¼˜åŒ–æ–¹æ¡ˆ**:
åœ¨çº¿å›¾ç‰‡ä¹Ÿå…ˆä¸‹è½½åˆ°æœ¬åœ°ï¼Œè½¬æ¢ä¸º base64 æ ¼å¼åå†ä¼ è¾“ç»™ OpenAI APIã€‚

**æ”¹è¿›å®ç°**:

```typescript
// æ–°å¢ï¼šä¸‹è½½å›¾ç‰‡å¹¶ç¼–ç ä¸º base64
private static async downloadAndEncodeImage(imageUrl: string): Promise<string> {
  const response = await fetch(imageUrl);
  if (!response.ok) {
    throw new ValidationError(`Failed to download image: HTTP ${response.status}`);
  }

  // éªŒè¯å†…å®¹ç±»å‹
  const contentType = response.headers.get('content-type');
  if (!contentType || !contentType.startsWith('image/')) {
    throw new ValidationError(`Invalid content type: ${contentType}`);
  }

  // éªŒè¯å¤§å°ï¼ˆä» headerï¼‰
  const contentLength = response.headers.get('content-length');
  if (contentLength && parseInt(contentLength) / (1024 * 1024) > 20) {
    throw new ValidationError(`Downloaded image too large`);
  }

  // ä¸‹è½½å¹¶ç¼–ç 
  const imageBuffer = Buffer.from(await response.arrayBuffer());
  const sizeInMB = imageBuffer.length / (1024 * 1024);
  if (sizeInMB > 20) {
    throw new ValidationError(`Downloaded image too large: ${sizeInMB.toFixed(2)}MB`);
  }

  return `data:${contentType};base64,${imageBuffer.toString('base64')}`;
}

// ä¿®æ”¹ï¼šencodeImageToBase64 æ–¹æ³•
static async encodeImageToBase64(imageSource: string): Promise<string> {
  if (this.isUrl(imageSource)) {
    // URL ä¹Ÿä¸‹è½½å¹¶ç¼–ç ä¸º base64
    return this.downloadAndEncodeImage(imageSource);
  }

  // æœ¬åœ°æ–‡ä»¶å¤„ç†ä¿æŒä¸å˜
  const imageBuffer = fs.readFileSync(imageSource);
  const ext = path.extname(imageSource).toLowerCase().slice(1);
  const mimeType = this.getMimeType(ext);
  return `data:${mimeType};base64,${imageBuffer.toString('base64')}`;
}

// å¢å¼ºï¼švalidateImageSource æ–¹æ³•
static async validateImageSource(imageSource: string, maxSizeMB: number = 20): Promise<void> {
  if (this.isUrl(imageSource)) {
    // éªŒè¯ URL æ ¼å¼
    const url = new URL(imageSource);
    if (!['http:', 'https:'].includes(url.protocol)) {
      throw new ValidationError(`Unsupported URL protocol: ${url.protocol}`);
    }
    // å®é™…å†…å®¹éªŒè¯åœ¨ä¸‹è½½æ—¶è¿›è¡Œ
    return;
  }

  // æœ¬åœ°æ–‡ä»¶éªŒè¯ä¿æŒä¸å˜
  // ...
}
```

**æ”¹è¿›ä¼˜åŠ¿**:
1. **å¯é æ€§é«˜**: ä¸‹è½½æˆåŠŸåç¡®ä¿å›¾ç‰‡æ•°æ®å®Œæ•´
2. **å¯éªŒè¯**: å¯ä»¥æå‰æ£€æŸ¥å›¾ç‰‡æ ¼å¼ã€å¤§å°
3. **å¯æ§æ€§å¼º**: èƒ½è¿›è¡Œå›¾ç‰‡ä¼˜åŒ–å’Œé¢„å¤„ç†
4. **å†…ç½‘å‹å¥½**: ä¸ä¾èµ– OpenAI æœåŠ¡å™¨çš„å¤–ç½‘è®¿é—®èƒ½åŠ›
5. **é”™è¯¯æ¸…æ™°**: ä¸‹è½½å¤±è´¥èƒ½æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·åŸå› 

**æ‰©å±•æ”¯æŒæ ¼å¼**:
```typescript
// æ”¯æŒæ›´å¤šå›¾ç‰‡æ ¼å¼
static getMimeType(extension: string): string {
  const mimeTypes = {
    png: 'image/png',
    jpg: 'image/jpeg',
    jpeg: 'image/jpeg',
    webp: 'image/webp',  // æ–°å¢
    gif: 'image/gif'      // æ–°å¢
  };
  return mimeTypes[extension] || 'image/png';
}
```

#### 4.3.4 æ›´æ–°æ–‡ä»¶å¤§å°é™åˆ¶

### 4.4 ApiCommon æ”¹é€ 

#### 4.4.1 åˆ é™¤è§†é¢‘å†…å®¹åˆ›å»ºå‡½æ•°

```javascript
// âŒ åˆ é™¤ç¬¬ 36-45 è¡Œ
export function createVideoContent(videoUrl) {
    return {
        type: 'video_url',
        video_url: { url: videoUrl }
    };
}
```

#### 4.4.2 ä¿ç•™çš„å‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

```javascript
// âœ… ä¿ç•™: åˆ›å»ºå›¾åƒå†…å®¹
export function createImageContent(imageUrl) {
    return {
        type: 'image_url',
        image_url: { url: imageUrl }
    };
}

// âœ… ä¿ç•™: åˆ›å»ºå¤šæ¨¡æ€æ¶ˆæ¯
export function createMultiModalMessage(content, prompt) {
    return [{
        role: 'user',
        content: [...content, { type: 'text', text: prompt }]
    }];
}

// âœ… ä¿ç•™: åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯
export function createTextMessage(prompt) {
    return [{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
    }];
}

// âœ… ä¿ç•™: é”™è¯¯/æˆåŠŸå“åº”åˆ›å»º
export function createErrorResponse(message, error) { ... }
export function createSuccessResponse(data) { ... }
export function formatMcpResponse(response) { ... }
export function withRetry(fn, maxRetries = 3, delay = 1000) { ... }
```

### 4.5 è§†é¢‘å·¥å…·åˆ é™¤

#### 4.5.1 åˆ é™¤æ–‡ä»¶

```bash
# åˆ é™¤æ•´ä¸ªè§†é¢‘å·¥å…·æ–‡ä»¶
rm build/tools/video-analysis.js
```

#### 4.5.2 æ›´æ–° index.js

**åˆ é™¤å¯¼å…¥** (ç¬¬ 17 è¡Œ):
```javascript
// âŒ åˆ é™¤
import { registerVideoAnalysisTool } from './tools/video-analysis.js';
```

**åˆ é™¤æ³¨å†Œ** (ç¬¬ 50 è¡Œ):
```javascript
// âŒ åˆ é™¤
registerVideoAnalysisTool(this.server);
```

**æ”¹é€ åçš„ `registerTools()` æ–¹æ³•**:
```javascript
async registerTools() {
    try {
        // æ³¨å†Œä¸“ç”¨å›¾åƒåˆ†æå·¥å…·
        registerUiToArtifactTool(this.server);
        registerTextExtractionTool(this.server);
        registerErrorDiagnosisTool(this.server);
        registerDiagramAnalysisTool(this.server);
        registerDataVizAnalysisTool(this.server);
        registerUiDiffCheckTool(this.server);
        registerGeneralImageAnalysisTool(this.server);

        console.info('Successfully registered all image analysis tools');
    } catch (error) {
        const standardError = await handleError(error, {
            operation: 'tool-registration',
            metadata: { component: 'McpServerApplication' }
        });
        console.error('Failed to register tools', standardError);
        throw standardError;
    }
}
```

### 4.6 å…¶ä»–æ–‡ä»¶æ”¹é€ 

#### 4.6.1 package.json

**æ›´æ–°åŒ…ä¿¡æ¯**:
```json
{
  "name": "@vision/mcp-server",
  "version": "0.1.0",
  "description": "MCP Server for Vision Analysis - A Model Context Protocol server that provides image analysis capabilities using OpenAI API",
  "main": "build/index.js",
  "type": "module",
  "bin": {
    "vision-mcp-server": "./build/index.js"
  },
  "keywords": [
    "vision",
    "mcp",
    "openai",
    "image-analysis",
    "ocr",
    "ui-analysis"
  ],
  "author": "Your Name",
  "license": "Apache-2.0"
}
```

#### 4.6.2 README.zh-CN.md

**æ›´æ–°æ–‡æ¡£å†…å®¹**:
```markdown
# Vision MCP Server

ä¸€ä¸ªåŸºäº OpenAI API æä¾›å›¾åƒåˆ†æèƒ½åŠ›çš„æ¨¡å‹ä¸Šä¸‹æ–‡åè®® (MCP) æœåŠ¡å™¨ã€‚

## å¯ç”¨å·¥å…·

è¯¥æœåŠ¡å™¨æä¾›é’ˆå¯¹ä¸åŒå›¾åƒåˆ†æä»»åŠ¡çš„ä¸“ä¸šå·¥å…·ï¼š

### å›¾åƒåˆ†æå·¥å…·

1. **`ui_to_artifact`** - å°† UI æˆªå›¾è½¬æ¢ä¸ºå„ç§äº§ç‰©
   - ä»è®¾è®¡ç¨¿ç”Ÿæˆå‰ç«¯ä»£ç 
   - åˆ›å»ºç”¨äº UI é‡å»ºçš„ AI æç¤ºè¯
   - æå–è®¾è®¡è§„èŒƒæ–‡æ¡£
   - ç”Ÿæˆ UI çš„è‡ªç„¶è¯­è¨€æè¿°

2. **`extract_text_from_screenshot`** - OCR æ–‡å­—æå–
   - ä»æˆªå›¾ä¸­æå–ä»£ç ï¼ˆä¿æŒæ­£ç¡®æ ¼å¼ï¼‰
   - æå–ç»ˆç«¯è¾“å‡ºå’Œæ—¥å¿—
   - æå–æ–‡æ¡£å’Œæ–‡æœ¬å†…å®¹
   - æ”¯æŒç¼–ç¨‹è¯­è¨€æç¤ºä»¥æé«˜å‡†ç¡®æ€§

3. **`diagnose_error_screenshot`** - é”™è¯¯è¯Šæ–­å’Œæ•…éšœæ’æŸ¥
   - åˆ†æé”™è¯¯æ¶ˆæ¯å’Œå †æ ˆè·Ÿè¸ª
   - è¯†åˆ«æ ¹æœ¬åŸå› 
   - æä¾›å¯æ“ä½œçš„è§£å†³æ–¹æ¡ˆ
   - å»ºè®®é¢„é˜²ç­–ç•¥

4. **`understand_technical_diagram`** - æŠ€æœ¯å›¾è¡¨åˆ†æ
   - åˆ†ææ¶æ„å›¾
   - ç†è§£æµç¨‹å›¾å’Œ UML å›¾
   - è§£é‡Š ER å›¾å’Œåºåˆ—å›¾
   - è¯†åˆ«è®¾è®¡æ¨¡å¼

5. **`analyze_data_visualization`** - æ•°æ®å¯è§†åŒ–æ´å¯Ÿ
   - ä»å›¾è¡¨ä¸­æå–æ´å¯Ÿ
   - è¯†åˆ«è¶‹åŠ¿å’Œæ¨¡å¼
   - æ£€æµ‹å¼‚å¸¸å€¼
   - æä¾›ä¸šåŠ¡å½±å“åˆ†æ

6. **`ui_diff_check`** - UI å¯¹æ¯”æ£€æŸ¥ï¼ˆè§†è§‰å›å½’æµ‹è¯•ï¼‰
   - æ¯”è¾ƒé¢„æœŸå’Œå®é™…çš„ UI å®ç°
   - è¯†åˆ«è§†è§‰å·®å¼‚
   - æä¾›è¯¦ç»†çš„å·®å¼‚æŠ¥å‘Š
   - æŒ‰ä¸¥é‡ç¨‹åº¦æ’åˆ—é—®é¢˜ä¼˜å…ˆçº§

7. **`analyze_image`** - é€šç”¨å›¾åƒåˆ†æï¼ˆå…œåº•å·¥å…·ï¼‰
   - å½“ä¸“ä¸šå·¥å…·ä¸é€‚ç”¨æ—¶ä½¿ç”¨
   - çµæ´»ç†è§£ä»»ä½•è§†è§‰å†…å®¹
   - å…¨é¢çš„å›¾åƒæè¿°å’Œåˆ†æ

## ç¯å¢ƒå˜é‡

- `OPENAI_API_KEY` - æ‚¨çš„ OpenAI API å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
- `OPENAI_BASE_URL` - OpenAI API åŸºç¡€ URLï¼ˆå¯é€‰ï¼Œé»˜è®¤: https://api.openai.com/v1ï¼‰
- `OPENAI_VISION_MODEL` - è§†è§‰æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤: gpt-4oï¼‰
- `OPENAI_MODEL_TEMPERATURE` - æ¨¡å‹æ¸©åº¦ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 0.8ï¼‰
- `OPENAI_MODEL_TOP_P` - Top P å‚æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 0.6ï¼‰
- `OPENAI_MODEL_MAX_TOKENS` - æœ€å¤§ tokensï¼ˆå¯é€‰ï¼Œé»˜è®¤: 32768ï¼‰
- `OPENAI_TIMEOUT` - è¯·æ±‚è¶…æ—¶æ—¶é—´ msï¼ˆå¯é€‰ï¼Œé»˜è®¤: 300000ï¼‰
- `OPENAI_RETRY_COUNT` - é‡è¯•æ¬¡æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 1ï¼‰

## å®‰è£…

### ä» npm å®‰è£…

\`\`\`bash
npm i @vision/mcp-server
\`\`\`

## ä½¿ç”¨æ–¹æ³•

### åœ¨ Claude Code ä¸­ä½¿ç”¨æ­¤ MCP æœåŠ¡å™¨

\`\`\`shell
claude mcp add vision-mcp-server --env OPENAI_API_KEY=your_api_key -- npx -y "@vision/mcp-server"
\`\`\`

## æ”¯æŒçš„æ¨¡å‹

- `gpt-4o` - OpenAI æœ€æ–°çš„å¤šæ¨¡æ€æ¨¡å‹ï¼ˆæ¨èï¼‰
- `gpt-4o-mini` - è½»é‡çº§å¤šæ¨¡æ€æ¨¡å‹
- `gpt-4-turbo` - é«˜æ€§èƒ½å¤šæ¨¡æ€æ¨¡å‹
- `gpt-4-vision-preview` - è§†è§‰é¢„è§ˆç‰ˆæ¨¡å‹
```

#### 4.6.3 ç±»å‹å®šä¹‰

**types/index.js**: æ— éœ€ä¿®æ”¹ï¼Œä¿æŒç°æœ‰çš„é”™è¯¯ç±»å‹å®šä¹‰å³å¯ã€‚

---

## äº”ã€æ”¹é€ å®æ–½æ­¥éª¤

### 5.1 å‡†å¤‡å·¥ä½œ

1. **å¤‡ä»½åŸå§‹ä»£ç **
   ```bash
   cp -r code-rag/mcp-server code-rag/mcp-server.backup
   ```

2. **åˆ›å»ºæ–°çš„é¡¹ç›®ç»“æ„**
   ```bash
   mkdir -p vision-mcp-server/src/{core,tools,prompts,types,utils}
   ```

3. **å®‰è£…ä¾èµ–**
   ```bash
   cd vision-mcp-server
   npm init -y
   npm install zod @modelcontextprotocol/sdk
   npm install -D typescript @types/node ts-node
   ```

### 5.2 æ ¸å¿ƒæœåŠ¡æ”¹é€ 

#### æ­¥éª¤ 1: æ”¹é€  EnvironmentService

**æ–‡ä»¶**: `src/core/environment.ts`

**æ“ä½œ**:
- åˆ é™¤æ™ºè°±å¹³å°ç›¸å…³çš„é€»è¾‘
- é‡å‘½åä¸º OpenAI ç›¸å…³çš„ç¯å¢ƒå˜é‡
- ç®€åŒ–é…ç½®åŠ è½½é€»è¾‘
- æ›´æ–°é»˜è®¤å€¼

**å…³é”®ä¿®æ”¹ç‚¹**:
```typescript
// ä¿®æ”¹é…ç½®é¡¹å
Z_AI_API_KEY â†’ OPENAI_API_KEY
Z_AI_BASE_URL â†’ OPENAI_BASE_URL
Z_AI_VISION_MODEL â†’ OPENAI_VISION_MODEL
...

// åˆ é™¤æ–¹æ³•
getPlatformModel()

// ç®€åŒ– loadEnvironmentConfig()
```

#### æ­¥éª¤ 2: æ”¹é€  ChatService

**æ–‡ä»¶**: `src/core/chat-service.ts`

**æ“ä½œ**:
- ç§»é™¤æ™ºè°±ç‰¹å®šçš„è¯·æ±‚å‚æ•°ï¼ˆthinkingï¼‰
- ç§»é™¤æ™ºè°±ç‰¹å®šçš„è¯·æ±‚å¤´ï¼ˆX-Titleï¼‰
- ä½¿ç”¨æ ‡å‡†çš„ OpenAI è¯·æ±‚æ ¼å¼
- æ›´æ–°é”™è¯¯æ¶ˆæ¯

**å…³é”®ä¿®æ”¹ç‚¹**:
```typescript
// ç§»é™¤ thinking å‚æ•°
// { type: 'enabled' }

// ç§»é™¤è¯·æ±‚å¤´
'X-Title': '4.5V MCP Local'

// æ›´æ–°æ—¥å¿—æ¶ˆæ¯
æ™ºè°± â†’ OpenAI
```

#### æ­¥éª¤ 3: æ”¹é€  FileService

**æ–‡ä»¶**: `src/core/file-service.ts`

**æ“ä½œ**:
- åˆ é™¤æ‰€æœ‰è§†é¢‘ç›¸å…³æ–¹æ³•
- ä¿ç•™æ‰€æœ‰å›¾åƒç›¸å…³æ–¹æ³•
- æ›´æ–°æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå¯é€‰ï¼‰

**åˆ é™¤çš„æ–¹æ³•**:
```typescript
validateVideoSource()
encodeVideoToBase64()
getVideoMimeType()
```

#### æ­¥éª¤ 4: æ”¹é€  ApiCommon

**æ–‡ä»¶**: `src/core/api-common.ts`

**æ“ä½œ**:
- åˆ é™¤ `createVideoContent()` å‡½æ•°
- ä¿ç•™æ‰€æœ‰å…¶ä»–å‡½æ•°

**åˆ é™¤çš„å‡½æ•°**:
```typescript
createVideoContent(videoUrl)
```

### 5.3 å·¥å…·å±‚æ”¹é€ 

#### æ­¥éª¤ 1: åˆ é™¤è§†é¢‘å·¥å…·

**æ“ä½œ**:
```bash
# åˆ é™¤æºæ–‡ä»¶
rm src/tools/video-analysis.ts

# å¦‚æœæœ‰ TypeScript æºæ–‡ä»¶ï¼Œä¹Ÿè¦åˆ é™¤
rm tools/video-analysis.ts
```

#### æ­¥éª¤ 2: æ›´æ–°å…¥å£æ–‡ä»¶

**æ–‡ä»¶**: `src/index.ts`

**æ“ä½œ**:
- åˆ é™¤è§†é¢‘å·¥å…·å¯¼å…¥
- åˆ é™¤è§†é¢‘å·¥å…·æ³¨å†Œ
- æ›´æ–°å·¥å…·æ•°é‡ï¼ˆ8â†’7ï¼‰

**ä¿®æ”¹**:
```typescript
// åˆ é™¤å¯¼å…¥
import { registerVideoAnalysisTool } from './tools/video-analysis.js';

// åˆ é™¤æ³¨å†Œ
registerVideoAnalysisTool(this.server);
```

### 5.4 é…ç½®æ–‡ä»¶æ”¹é€ 

#### æ­¥éª¤ 1: æ›´æ–° package.json

**æ–‡ä»¶**: `package.json`

**æ“ä½œ**:
- æ›´æ–°åŒ…å
- æ›´æ–°æè¿°
- æ›´æ–°å…³é”®è¯
- æ›´æ–°ç‰ˆæœ¬å·

#### æ­¥éª¤ 2: æ›´æ–° README

**æ–‡ä»¶**: `README.zh-CN.md`

**æ“ä½œ**:
- ç§»é™¤è§†é¢‘ç›¸å…³æè¿°
- æ›´æ–°ç¯å¢ƒå˜é‡è¯´æ˜
- æ›´æ–°ä½¿ç”¨ç¤ºä¾‹
- æ›´æ–°æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨

### 5.5 ç¼–è¯‘å’Œæµ‹è¯•

#### æ­¥éª¤ 1: ç¼–è¯‘ TypeScript

```bash
npm run build
```

#### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

```bash
export OPENAI_API_KEY="sk-..."
export OPENAI_VISION_MODEL="gpt-4o"
```

#### æ­¥éª¤ 3: æµ‹è¯•å¯åŠ¨

```bash
node build/index.js
```

#### æ­¥éª¤ 4: åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•æ¯ä¸ªå·¥å…·**:
1. `ui_to_artifact`
2. `extract_text_from_screenshot`
3. `diagnose_error_screenshot`
4. `understand_technical_diagram`
5. `analyze_data_visualization`
6. `ui_diff_check`
7. `analyze_image`

**æµ‹è¯•å‘½ä»¤**ï¼ˆåœ¨ Claude Code ä¸­ï¼‰:
```bash
# æµ‹è¯• UI è½¬ä»£ç 
claude call ui_to_artifact image_source=./test-ui.png output_type=code prompt="Generate React code"

# æµ‹è¯•æ–‡å­—æå–
claude call extract_text_from_screenshot image_source=./test-code.png prompt="Extract the code"

# æµ‹è¯•é”™è¯¯è¯Šæ–­
claude call diagnose_error_screenshot image_source=./test-error.png prompt="What's wrong?"
```

### 5.6 éªŒè¯å’Œä¼˜åŒ–

#### éªŒè¯æ¸…å•

- [ ] æ‰€æœ‰ 7 ä¸ªå›¾åƒå·¥å…·æ­£å¸¸å·¥ä½œ
- [ ] è§†é¢‘å·¥å…·å·²è¢«å®Œå…¨ç§»é™¤
- [ ] ç¯å¢ƒå˜é‡æ­£ç¡®è¯»å–
- [ ] OpenAI API è°ƒç”¨æˆåŠŸ
- [ ] é”™è¯¯å¤„ç†æ­£å¸¸å·¥ä½œ
- [ ] æ—¥å¿—è¾“å‡ºæ­£ç¡®
- [ ] æ–‡æ¡£å·²æ›´æ–°

#### æ€§èƒ½ä¼˜åŒ–

- [ ] æµ‹è¯•å›¾åƒå¤„ç†é€Ÿåº¦
- [ ] ä¼˜åŒ– Base64 ç¼–ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] è°ƒæ•´è¶…æ—¶æ—¶é—´ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] ä¼˜åŒ–é‡è¯•ç­–ç•¥

#### å…¼å®¹æ€§æµ‹è¯•

- [ ] æµ‹è¯•ä¸åŒå›¾åƒæ ¼å¼ï¼ˆPNG, JPG, JPEGï¼‰
- [ ] æµ‹è¯•æœ¬åœ°æ–‡ä»¶å’Œ URL
- [ ] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆæ¥è¿‘ 20MBï¼‰
- [ ] æµ‹è¯•é”™è¯¯åœºæ™¯

---

## å…­ã€æ–‡ä»¶ä¿®æ”¹æ¸…å•

### 6.1 éœ€è¦åˆ é™¤çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | åŸå›  |
|---------|------|
| `build/tools/video-analysis.js` | è§†é¢‘åˆ†æå·¥å…· |
| `tools/video-analysis.ts` | è§†é¢‘åˆ†æå·¥å…·æºç  |

### 6.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹å†…å®¹ |
|---------|---------|---------|
| `src/core/environment.ts` | é‡æ„ | æ”¹é€ ä¸º OpenAI é…ç½® |
| `src/core/chat-service.ts` | é‡æ„ | æ”¹é€ ä¸º OpenAI API æ ¼å¼ |
| `src/core/file-service.ts` | åˆ é™¤ | åˆ é™¤è§†é¢‘ç›¸å…³æ–¹æ³• |
| `src/core/api-common.ts` | åˆ é™¤ | åˆ é™¤ createVideoContent |
| `src/index.ts` | åˆ é™¤ | åˆ é™¤è§†é¢‘å·¥å…·æ³¨å†Œ |
| `package.json` | æ›´æ–° | æ›´æ–°åŒ…ä¿¡æ¯ |
| `README.zh-CN.md` | æ›´æ–° | æ›´æ–°æ–‡æ¡£ |

### 6.3 æ— éœ€ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | åŸå›  |
|---------|------|
| `src/core/base-image-service.ts` | ä¸æ¶‰åŠè§†é¢‘ï¼Œæ¶æ„æ— éœ€ä¿®æ”¹ |
| `src/tools/ui-to-artifact.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/text-extraction.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/error-diagnosis.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/diagram-analysis.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/data-viz.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/ui-diff.ts` | åªå¤„ç†å›¾åƒ |
| `src/tools/general-image.ts` | åªå¤„ç†å›¾åƒ |
| `src/prompts/*.ts` | æç¤ºè¯æ— éœ€ä¿®æ”¹ |
| `src/types/index.ts` | é”™è¯¯ç±»å‹é€šç”¨ |
| `src/utils/logger.ts` | æ—¥å¿—ç³»ç»Ÿé€šç”¨ |
| `src/utils/validation.ts` | éªŒè¯é€»è¾‘é€šç”¨ |

---

## ä¸ƒã€é£é™©è¯„ä¼°ä¸åº”å¯¹

### 7.1 æŠ€æœ¯é£é™©

#### é£é™© 1: OpenAI API å…¼å®¹æ€§

**æè¿°**: OpenAI API çš„å“åº”æ ¼å¼å¯èƒ½ä¸æ™ºè°± API å­˜åœ¨ç»†å¾®å·®å¼‚ã€‚

**å½±å“**: ä¸­ç­‰

**åº”å¯¹æªæ–½**:
- è¯¦ç»†é˜…è¯» OpenAI API æ–‡æ¡£
- æµ‹è¯•å„ç§åœºæ™¯ï¼ˆæ­£å¸¸ã€é”™è¯¯ã€è¾¹ç•Œï¼‰
- æ·»åŠ å“åº”éªŒè¯é€»è¾‘
- å®ç°é™çº§æ–¹æ¡ˆ

#### é£é™© 2: æ¨¡å‹èƒ½åŠ›å·®å¼‚

**æè¿°**: OpenAI çš„è§†è§‰æ¨¡å‹èƒ½åŠ›å¯èƒ½ä¸æ™ºè°±çš„ glm-4.6v å­˜åœ¨å·®å¼‚ã€‚

**å½±å“**: ä¸­ç­‰

**åº”å¯¹æªæ–½**:
- æä¾›å¤šä¸ªæ¨¡å‹é€‰æ‹©ï¼ˆgpt-4o, gpt-4o-mini ç­‰ï¼‰
- å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å‹
- è°ƒæ•´æç¤ºè¯ä»¥é€‚é… OpenAI æ¨¡å‹
- è¿›è¡Œ A/B æµ‹è¯•

#### é£é™© 3: æˆæœ¬å¢åŠ 

**æè¿°**: OpenAI API çš„è°ƒç”¨æˆæœ¬å¯èƒ½é«˜äºæ™ºè°± APIã€‚

**å½±å“**: é«˜

**åº”å¯¹æªæ–½**:
- é»˜è®¤ä½¿ç”¨ gpt-4o-miniï¼ˆæ›´ä¾¿å®œï¼‰
- æä¾›æ¨¡å‹åˆ‡æ¢é€‰é¡¹
- å®ç°ç¼“å­˜æœºåˆ¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ä¼˜åŒ–å›¾åƒå¤§å°

### 7.2 å®æ–½é£é™©

#### é£é™© 1: é…ç½®è¿ç§»é—®é¢˜

**æè¿°**: ç”¨æˆ·ä»æ™ºè°±è¿ç§»æ—¶å¯èƒ½é‡åˆ°é…ç½®é—®é¢˜ã€‚

**å½±å“**: ä½

**åº”å¯¹æªæ–½**:
- æä¾›è¯¦ç»†çš„è¿ç§»æŒ‡å—
- æä¾›é…ç½®éªŒè¯å·¥å…·
- åœ¨é”™è¯¯æ¶ˆæ¯ä¸­ç»™å‡ºæ˜ç¡®æç¤º
- æä¾›é…ç½®ç¤ºä¾‹

#### é£é™© 2: ä»£ç å¼•å…¥æ–° Bug

**æè¿°**: æ”¹é€ è¿‡ç¨‹ä¸­å¯èƒ½å¼•å…¥æ–°çš„ Bugã€‚

**å½±å“**: ä¸­ç­‰

**åº”å¯¹æªæ–½**:
- ä¿æŒç°æœ‰æ¶æ„ä¸å˜
- åªä¿®æ”¹å¿…è¦çš„éƒ¨åˆ†
- è¿›è¡Œå……åˆ†æµ‹è¯•
- ä»£ç å®¡æŸ¥

### 7.3 å…¼å®¹æ€§é£é™©

#### é£é™© 1: å›¾åƒæ ¼å¼æ”¯æŒå·®å¼‚

**æè¿°**: OpenAI å¯èƒ½ä¸æ”¯æŒæŸäº›å›¾åƒæ ¼å¼ã€‚

**å½±å“**: ä½

**åº”å¯¹æªæ–½**:
- åªä½¿ç”¨ OpenAI æ”¯æŒçš„æ ¼å¼ï¼ˆPNG, JPG, JPEGï¼‰
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜
- æ·»åŠ æ ¼å¼è½¬æ¢å»ºè®®

#### é£é™© 2: æ–‡ä»¶å¤§å°é™åˆ¶å·®å¼‚

**æè¿°**: OpenAI çš„æ–‡ä»¶å¤§å°é™åˆ¶å¯èƒ½ä¸åŒã€‚

**å½±å“**: ä½

**åº”å¯¹æªæ–½**:
- è®¾ç½®åˆç†çš„é»˜è®¤å€¼ï¼ˆ20MBï¼‰
- å…è®¸ç”¨æˆ·è‡ªå®šä¹‰
- åœ¨æ–‡æ¡£ä¸­è¯´æ˜é™åˆ¶

---

## å…«ã€æµ‹è¯•æ–¹æ¡ˆ

### 8.1 å•å…ƒæµ‹è¯•

#### ç¯å¢ƒé…ç½®æµ‹è¯•

```typescript
describe('EnvironmentService', () => {
    test('should load OPENAI_API_KEY', () => {
        process.env.OPENAI_API_KEY = 'sk-test';
        const config = EnvironmentService.getInstance().getConfig();
        expect(config.OPENAI_API_KEY).toBe('sk-test');
    });

    test('should throw error when API key is missing', () => {
        delete process.env.OPENAI_API_KEY;
        expect(() => {
            EnvironmentService.getInstance().loadEnvironmentConfig();
        }).toThrow('OPENAI_API_KEY environment variable is required');
    });

    test('should throw error when API key is placeholder', () => {
        process.env.OPENAI_API_KEY = 'your_api_key';
        expect(() => {
            EnvironmentService.getInstance().loadEnvironmentConfig();
        }).toThrow('appears to be a placeholder');
    });
});
```

#### ChatService æµ‹è¯•

```typescript
describe('ChatService', () => {
    test('should call OpenAI API with correct format', async () => {
        const mockFetch = jest.fn().mockResolvedValue({
            ok: true,
            json: async () => ({
                choices: [{ message: { content: 'test response' } }]
            })
        });
        global.fetch = mockFetch;

        const service = new ChatService();
        const result = await service.visionCompletions([
            { role: 'user', content: 'test' }
        ]);

        expect(mockFetch).toHaveBeenCalledWith(
            expect.stringContaining('chat/completions'),
            expect.objectContaining({
                method: 'POST',
                headers: expect.objectContaining({
                    'Authorization': expect.stringContaining('Bearer'),
                    'Content-Type': 'application/json'
                }),
                body: expect.stringContaining('gpt-4o')
            })
        );
        expect(result).toBe('test response');
    });
});
```

#### FileService æµ‹è¯•

```typescript
describe('FileService', () => {
    test('should validate image file', async () => {
        // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        const testImage = '/tmp/test.jpg';
        fs.writeFileSync(testImage, Buffer.from('fake image'));

        await expect(
            FileService.validateImageSource(testImage)
        ).resolves.not.toThrow();

        fs.unlinkSync(testImage);
    });

    test('should throw error for non-existent file', async () => {
        await expect(
            FileService.validateImageSource('/nonexistent.jpg')
        ).rejects.toThrow('Image file not found');
    });

    test('should throw error for unsupported format', async () => {
        const testFile = '/tmp/test.bmp';
        fs.writeFileSync(testFile, Buffer.from('fake'));

        await expect(
            FileService.validateImageSource(testFile)
        ).rejects.toThrow('Unsupported image format');

        fs.unlinkSync(testFile);
    });

    test('should download and encode online image to base64', async () => {
        const testImageUrl = 'https://example.com/test-image.jpg';
        // Mock fetch to return test image
        global.fetch = jest.fn().mockResolvedValue({
            ok: true,
            headers: new Map([['content-type', 'image/jpeg']]),
            arrayBuffer: async () => Buffer.from('fake image data')
        });

        const result = await FileService.encodeImageToBase64(testImageUrl);

        expect(result).toMatch(/^data:image\/jpeg;base64,/);
        expect(global.fetch).toHaveBeenCalledWith(testImageUrl);
    });

    test('should throw error for invalid URL protocol', async () => {
        await expect(
            FileService.validateImageSource('ftp://example.com/image.jpg')
        ).rejects.toThrow('Unsupported URL protocol');
    });

    test('should throw error when download fails', async () => {
        const testImageUrl = 'https://example.com/not-found.jpg';
        global.fetch = jest.fn().mockResolvedValue({
            ok: false,
            status: 404,
            statusText: 'Not Found'
        });

        await expect(
            FileService.encodeImageToBase64(testImageUrl)
        ).rejects.toThrow('Failed to download image');
    });

    test('should throw error for non-image content type', async () => {
        const testImageUrl = 'https://example.com/file.txt';
        global.fetch = jest.fn().mockResolvedValue({
            ok: true,
            headers: new Map([['content-type', 'text/plain']]),
            arrayBuffer: async () => Buffer.from('text')
        });

        await expect(
            FileService.encodeImageToBase64(testImageUrl)
        ).rejects.toThrow('Invalid content type');
    });

    test('should throw error for oversized online image', async () => {
        const testImageUrl = 'https://example.com/large.jpg';
        global.fetch = jest.fn().mockResolvedValue({
            ok: true,
            headers: new Map([
                ['content-type', 'image/jpeg'],
                ['content-length', '25165824'] // 24MB
            ]),
            arrayBuffer: async () => Buffer.alloc(25165824)
        });

        await expect(
            FileService.encodeImageToBase64(testImageUrl)
        ).rejects.toThrow('Downloaded image too large');
    });
});
```

### 8.2 é›†æˆæµ‹è¯•

#### ç«¯åˆ°ç«¯æµ‹è¯•

```typescript
describe('MCP Server Integration', () => {
    let server: McpServerApplication;

    beforeAll(async () => {
        process.env.OPENAI_API_KEY = process.env.TEST_API_KEY || 'sk-test';
        server = new McpServerApplication();
        await server.registerTools();
    });

    afterAll(async () => {
        await server.shutdown();
    });

    test('should register all 7 image tools', () => {
        const tools = server.server.getTools();
        expect(tools.length).toBe(7);
        expect(tools.map(t => t.name)).toContain('ui_to_artifact');
        expect(tools.map(t => t.name)).toContain('analyze_video').toBeFalsy();
    });

    test('should handle UI to artifact request', async () => {
        const result = await server.server.callTool({
            name: 'ui_to_artifact',
            arguments: {
                image_source: './test-ui.png',
                output_type: 'code',
                prompt: 'Generate code'
            }
        });
        expect(result.content[0].type).toBe('text');
    });
});
```

### 8.3 æ‰‹åŠ¨æµ‹è¯•æ¸…å•

#### å›¾åƒæ ¼å¼æµ‹è¯•

- [ ] æµ‹è¯• PNG æ–‡ä»¶
- [ ] æµ‹è¯• JPG æ–‡ä»¶
- [ ] æµ‹è¯• JPEG æ–‡ä»¶
- [ ] æµ‹è¯•ä¸æ”¯æŒçš„æ ¼å¼ï¼ˆåº”æŠ¥é”™ï¼‰

#### è¾“å…¥æºæµ‹è¯•

- [ ] æµ‹è¯•æœ¬åœ°æ–‡ä»¶è·¯å¾„
- [ ] æµ‹è¯• HTTP URL
- [ ] æµ‹è¯• HTTPS URL
- [ ] æµ‹è¯•åœ¨çº¿å›¾ç‰‡ä¸‹è½½ï¼ˆç¡®ä¿ä¸‹è½½æˆåŠŸå¹¶è½¬ä¸º base64ï¼‰
- [ ] æµ‹è¯•åœ¨çº¿å›¾ç‰‡å¤§å°éªŒè¯ï¼ˆè¶…è¿‡ 20MB åº”æŠ¥é”™ï¼‰
- [ ] æµ‹è¯•åœ¨çº¿å›¾ç‰‡æ ¼å¼éªŒè¯ï¼ˆéå›¾ç‰‡æ ¼å¼åº”æŠ¥é”™ï¼‰
- [ ] æµ‹è¯•ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆåº”æŠ¥é”™ï¼‰
- [ ] æµ‹è¯•æ— æ•ˆçš„ URLï¼ˆåº”æŠ¥é”™ï¼‰
- [ ] æµ‹è¯•å†…ç½‘ URLï¼ˆå¦‚æœ OpenAI æ— æ³•è®¿é—®ï¼Œåº”èƒ½æ­£å¸¸å·¥ä½œï¼‰
- [ ] æµ‹è¯•å¤±æ•ˆçš„å›¾ç‰‡é“¾æ¥ï¼ˆåº”æŠ¥é”™ï¼‰

#### å·¥å…·åŠŸèƒ½æµ‹è¯•

- [ ] `ui_to_artifact` - ç”Ÿæˆä»£ç 
- [ ] `ui_to_artifact` - ç”Ÿæˆæç¤ºè¯
- [ ] `ui_to_artifact` - ç”Ÿæˆè§„èŒƒ
- [ ] `ui_to_artifact` - ç”Ÿæˆæè¿°
- [ ] `extract_text_from_screenshot` - æå–ä»£ç 
- [ ] `extract_text_from_screenshot` - æå–æ–‡æœ¬
- [ ] `diagnose_error_screenshot` - è¯Šæ–­é”™è¯¯
- [ ] `understand_technical_diagram` - åˆ†ææ¶æ„å›¾
- [ ] `understand_technical_diagram` - åˆ†ææµç¨‹å›¾
- [ ] `analyze_data_visualization` - åˆ†æå›¾è¡¨
- [ ] `ui_diff_check` - å¯¹æ¯” UI
- [ ] `analyze_image` - é€šç”¨åˆ†æ

#### é”™è¯¯å¤„ç†æµ‹è¯•

- [ ] æµ‹è¯•æ— æ•ˆçš„ API Key
- [ ] æµ‹è¯•ç½‘ç»œé”™è¯¯
- [ ] æµ‹è¯•è¶…æ—¶
- [ ] æµ‹è¯• API é™æµ
- [ ] æµ‹è¯•æ— æ•ˆçš„å‚æ•°

#### æ€§èƒ½æµ‹è¯•

- [ ] æµ‹è¯•å°æ–‡ä»¶ï¼ˆ< 1MBï¼‰
- [ ] æµ‹è¯•ä¸­ç­‰æ–‡ä»¶ï¼ˆ5MBï¼‰
- [ ] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ15MBï¼‰
- [ ] æµ‹è¯•æ¥è¿‘é™åˆ¶ï¼ˆ20MBï¼‰
- [ ] æµ‹è¯•å¹¶å‘è¯·æ±‚

---

## ä¹ã€éƒ¨ç½²æ–¹æ¡ˆ

### 9.1 å‘å¸ƒæµç¨‹

#### æ­¥éª¤ 1: å‡†å¤‡å‘å¸ƒ

```bash
# 1. æ›´æ–°ç‰ˆæœ¬å·
npm version patch  # æˆ– minor, major

# 2. è¿è¡Œå®Œæ•´æµ‹è¯•
npm test

# 3. æ„å»ºé¡¹ç›®
npm run build

# 4. éªŒè¯æ„å»ºäº§ç‰©
ls -la build/
```

#### æ­¥éª¤ 2: å‘å¸ƒåˆ° npm

```bash
# 1. ç™»å½• npm
npm login

# 2. å‘å¸ƒ
npm publish

# 3. éªŒè¯å‘å¸ƒ
npm view @vision/mcp-server
```

### 9.2 ç”¨æˆ·è¿ç§»æŒ‡å—

#### ä»æ™ºè°±è¿ç§»

**æ—§é…ç½®**:
```bash
export Z_AI_API_KEY="your_zhipu_key"
export PLATFORM_MODE="ZHIPU"
```

**æ–°é…ç½®**:
```bash
export OPENAI_API_KEY="sk-your-openai-key"
export OPENAI_VISION_MODEL="gpt-4o"
```

#### å®‰è£…æ–°ç‰ˆæœ¬

```bash
# å¸è½½æ—§ç‰ˆæœ¬
npm uninstall -g @z_ai/mcp-server

# å®‰è£…æ–°ç‰ˆæœ¬
npm install -g @vision/mcp-server

# æ›´æ–° Claude Code é…ç½®
claude mcp remove zai-mcp-server
claude mcp add vision-mcp-server --env OPENAI_API_KEY=sk-... -- npx -y "@vision/mcp-server"
```

### 9.3 æ–‡æ¡£æ›´æ–°

#### README å†…å®¹

- [ ] æ›´æ–°é¡¹ç›®æè¿°
- [ ] æ›´æ–°å®‰è£…è¯´æ˜
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡è¯´æ˜
- [ ] æ›´æ–°ä½¿ç”¨ç¤ºä¾‹
- [ ] æ›´æ–°å·¥å…·åˆ—è¡¨ï¼ˆç§»é™¤è§†é¢‘ï¼‰
- [ ] æ›´æ–°æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨

#### API æ–‡æ¡£

- [ ] æ›´æ–° API ç«¯ç‚¹
- [ ] æ›´æ–°è¯·æ±‚æ ¼å¼
- [ ] æ›´æ–°å“åº”æ ¼å¼
- [ ] æ›´æ–°é”™è¯¯ç 

#### è¿ç§»æŒ‡å—

- [ ] åˆ›å»ºè¿ç§»æ–‡æ¡£
- [ ] æä¾›é…ç½®å¯¹æ¯”è¡¨
- [ ] æä¾›å¸¸è§é—®é¢˜è§£ç­”
- [ ] æä¾›æ•…éšœæ’æŸ¥æŒ‡å—

---

## åã€åœ¨çº¿é“¾æ¥å¤„ç†æ”¹è¿›

### 10.1 é—®é¢˜èƒŒæ™¯

åœ¨é¡¹ç›®æ”¹é€ è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªé‡è¦é—®é¢˜ï¼š**åœ¨çº¿å›¾ç‰‡é“¾æ¥çš„å¤„ç†æ–¹å¼ä¸å¤Ÿå¯é **ã€‚

**åŸå®ç°çš„é—®é¢˜**:
```typescript
// åŸä»£ç ï¼šç›´æ¥ä¼ é€’ URL ç»™ OpenAI
if (this.isUrl(imageSource)) {
  return imageSource;  // âŒ ç›´æ¥ä¼  URLï¼Œä¸å¤„ç†
}
```

**æ½œåœ¨é£é™©**:
1. OpenAI æœåŠ¡å™¨å¯èƒ½æ— æ³•è®¿é—®å†…ç½‘ã€ç§æœ‰äº‘æˆ–éœ€è¦è®¤è¯çš„å›¾ç‰‡é“¾æ¥
2. å›¾ç‰‡é“¾æ¥å¯èƒ½è¿‡æœŸæˆ–è¢«åˆ é™¤ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥
3. æ— æ³•é¢„å¤„ç†å›¾ç‰‡ï¼ˆå‹ç¼©ã€æ ¼å¼è½¬æ¢ã€å°ºå¯¸ä¼˜åŒ–ï¼‰
4. å¤±è´¥æ’æŸ¥å›°éš¾ï¼Œæ— æ³•ç¡®å®šæ˜¯å›¾ç‰‡é—®é¢˜è¿˜æ˜¯ç½‘ç»œé—®é¢˜
5. ç¼ºä¹å¤§å°å’Œæ ¼å¼éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´ API è°ƒç”¨å¤±è´¥

### 10.2 è§£å†³æ–¹æ¡ˆ

**æ–°å®ç°**: å…ˆä¸‹è½½å›¾ç‰‡ï¼Œè½¬æ¢ä¸º base64 æ ¼å¼ï¼Œå†ä¼ é€’ç»™ OpenAIã€‚

```typescript
// æ–°ä»£ç ï¼šä¸‹è½½å¹¶è½¬æ¢ä¸º base64
if (this.isUrl(imageSource)) {
  return this.downloadAndEncodeImage(imageSource);  // âœ… ä¸‹è½½åç¼–ç 
}
```

#### 10.2.1 æ ¸å¿ƒæ”¹è¿›

**1. æ–°å¢ `downloadAndEncodeImage` æ–¹æ³•**:

```typescript
private static async downloadAndEncodeImage(imageUrl: string): Promise<string> {
  console.debug('Downloading image from URL', { imageUrl });

  try {
    // 1. å‘èµ·ä¸‹è½½è¯·æ±‚
    const response = await fetch(imageUrl);
    if (!response.ok) {
      throw new ValidationError(
        `Failed to download image: HTTP ${response.status} ${response.statusText}`
      );
    }

    // 2. éªŒè¯å†…å®¹ç±»å‹
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.startsWith('image/')) {
      throw new ValidationError(
        `Invalid content type: ${contentType}. Expected image/*`
      );
    }

    // 3. éªŒè¯å¤§å°ï¼ˆä» headerï¼‰
    const contentLength = response.headers.get('content-length');
    if (contentLength) {
      const sizeInMB = parseInt(contentLength) / (1024 * 1024);
      if (sizeInMB > 20) {
        throw new ValidationError(
          `Downloaded image too large: ${sizeInMB.toFixed(2)}MB. Maximum allowed: 20MB`
        );
      }
    }

    // 4. ä¸‹è½½å›¾ç‰‡æ•°æ®
    const imageBuffer = Buffer.from(await response.arrayBuffer());

    // 5. å†æ¬¡éªŒè¯å¤§å°ï¼ˆä»å®é™…æ•°æ®ï¼‰
    const actualSizeInMB = imageBuffer.length / (1024 * 1024);
    if (actualSizeInMB > 20) {
      throw new ValidationError(
        `Downloaded image too large: ${actualSizeInMB.toFixed(2)}MB. Maximum allowed: 20MB`
      );
    }

    console.debug('Successfully downloaded and encoded image', {
      imageUrl,
      contentType,
      sizeInMB: actualSizeInMB.toFixed(2)
    });

    // 6. è¿”å› base64 ç¼–ç 
    return `data:${contentType};base64,${imageBuffer.toString('base64')}`;
  } catch (error) {
    if (error instanceof ValidationError) {
      throw error;
    }
    throw new ValidationError(
      `Failed to download image from URL: ${imageUrl}. ` +
      `Error: ${error instanceof Error ? error.message : String(error)}`
    );
  }
}
```

**2. å¢å¼º `validateImageSource` æ–¹æ³•**:

```typescript
static async validateImageSource(imageSource: string, maxSizeMB: number = 20): Promise<void> {
  if (this.isUrl(imageSource)) {
    // éªŒè¯ URL æ ¼å¼
    try {
      const url = new URL(imageSource);
      if (!['http:', 'https:'].includes(url.protocol)) {
        throw new ValidationError(
          `Unsupported URL protocol: ${url.protocol}. Only http:// and https:// are supported.`
        );
      }
    } catch (error) {
      if (error instanceof ValidationError) {
        throw error;
      }
      throw new ValidationError(
        `Invalid URL format: ${imageSource}. Error: ${error instanceof Error ? error.message : String(error)}`
      );
    }
    // æ³¨æ„ï¼šå®é™…å†…å®¹éªŒè¯åœ¨ä¸‹è½½æ—¶è¿›è¡Œ
    return;
  }

  // æœ¬åœ°æ–‡ä»¶éªŒè¯ä¿æŒä¸å˜
  // ...
}
```

**3. æ‰©å±•æ”¯æŒçš„å›¾ç‰‡æ ¼å¼**:

```typescript
static getMimeType(extension: string): string {
  const mimeTypes: Record<string, string> = {
    png: 'image/png',
    jpg: 'image/jpeg',
    jpeg: 'image/jpeg',
    webp: 'image/webp',  // æ–°å¢
    gif: 'image/gif'      // æ–°å¢
  };
  return mimeTypes[extension] || 'image/png';
}
```

### 10.3 æ”¹è¿›ä¼˜åŠ¿

| æ–¹é¢ | åŸå®ç° | æ–°å®ç° | ä¼˜åŠ¿ |
|-----|-------|-------|------|
| **å¯é æ€§** | ä¾èµ– OpenAI è®¿é—®èƒ½åŠ› | æœ¬åœ°ä¸‹è½½ç¡®ä¿æ•°æ®å®Œæ•´ | âœ… ä¸å—å¤–ç½‘é™åˆ¶ |
| **éªŒè¯** | æ— å¤§å°/æ ¼å¼éªŒè¯ | å®Œæ•´çš„å¤§å°å’Œæ ¼å¼æ£€æŸ¥ | âœ… æå‰å‘ç°é—®é¢˜ |
| **å¯æ§æ€§** | æ— æ³•é¢„å¤„ç† | å¯å‹ç¼©ã€è½¬æ¢æ ¼å¼ | âœ… çµæ´»ä¼˜åŒ– |
| **å†…ç½‘å‹å¥½** | å¯èƒ½å¤±è´¥ | å®Œå…¨æ”¯æŒå†…ç½‘ | âœ… é€‚ç”¨äºç§æœ‰ç½‘ç»œ |
| **é”™è¯¯å¤„ç†** | æ¨¡ç³Šçš„ API é”™è¯¯ | æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ | âœ… æ˜“äºè°ƒè¯• |
| **æ ¼å¼æ”¯æŒ** | ä»…æœ¬åœ°æ–‡ä»¶æ£€æŸ¥ | æ”¯æŒåœ¨çº¿å›¾ç‰‡çš„å¤šç§æ ¼å¼ | âœ… æ›´çµæ´» |

### 10.4 å¤„ç†æµç¨‹å¯¹æ¯”

#### åŸæµç¨‹ï¼ˆç›´æ¥ä¼  URLï¼‰
```
ç”¨æˆ·ä¼ å…¥ URL â†’ è¯†åˆ«ä¸º URL â†’ ç›´æ¥ä¼ ç»™ OpenAI API
  â†“
  â†“ (é£é™©ï¼šOpenAI æ— æ³•è®¿é—®å†…ç½‘ã€é“¾æ¥å¤±æ•ˆç­‰)
  â†“
OpenAI æœåŠ¡å™¨å°è¯•è®¿é—® URL â†’ å¯èƒ½å¤±è´¥ â†’ è¿”å›æ¨¡ç³Šé”™è¯¯
```

#### æ–°æµç¨‹ï¼ˆä¸‹è½½ + base64ï¼‰
```
ç”¨æˆ·ä¼ å…¥ URL â†’ è¯†åˆ«ä¸º URL â†’ éªŒè¯ URL æ ¼å¼
  â†“
ä¸‹è½½å›¾ç‰‡ â†’ éªŒè¯å†…å®¹ç±»å‹ â†’ éªŒè¯å¤§å° â†’ ç¼–ç ä¸º base64
  â†“
ä¼ é€’ base64 æ•°æ®ç»™ OpenAI API â†’ âœ… ç¡®ä¿æ•°æ®å®Œæ•´
```

### 10.5 é”™è¯¯å¤„ç†æ”¹è¿›

**åŸå®ç°**:
- é”™è¯¯ä¿¡æ¯æ¨¡ç³Šï¼š"Failed to analyze image"
- æ— æ³•åŒºåˆ†æ˜¯ç½‘ç»œé—®é¢˜ã€å›¾ç‰‡é—®é¢˜è¿˜æ˜¯ API é—®é¢˜

**æ–°å®ç°**:
- æ¸…æ™°çš„é”™è¯¯åˆ†ç±»ï¼š
  - URL æ ¼å¼é”™è¯¯ï¼š`Invalid URL format`
  - ä¸‹è½½å¤±è´¥ï¼š`Failed to download image: HTTP 404`
  - å†…å®¹ç±»å‹é”™è¯¯ï¼š`Invalid content type: text/plain. Expected image/*`
  - å¤§å°è¶…é™ï¼š`Downloaded image too large: 25.3MB. Maximum allowed: 20MB`
- åŒ…å«è¯¦ç»†ä¸Šä¸‹æ–‡ï¼šURLã€HTTP çŠ¶æ€ç ã€å®é™…å¤§å°ç­‰

### 10.6 æµ‹è¯•è¦†ç›–

**å•å…ƒæµ‹è¯•**:
```typescript
// ä¸‹è½½æˆåŠŸå¹¶ç¼–ç 
test('should download and encode online image to base64', async () => {
  const testImageUrl = 'https://example.com/test-image.jpg';
  // Mock fetch è¿”å›æµ‹è¯•å›¾ç‰‡
  const result = await FileService.encodeImageToBase64(testImageUrl);
  expect(result).toMatch(/^data:image\/jpeg;base64,/);
});

// URL åè®®éªŒè¯
test('should throw error for invalid URL protocol', async () => {
  await expect(
    FileService.validateImageSource('ftp://example.com/image.jpg')
  ).rejects.toThrow('Unsupported URL protocol');
});

// ä¸‹è½½å¤±è´¥å¤„ç†
test('should throw error when download fails', async () => {
  global.fetch = jest.fn().mockResolvedValue({
    ok: false,
    status: 404,
    statusText: 'Not Found'
  });
  await expect(
    FileService.encodeImageToBase64('https://example.com/not-found.jpg')
  ).rejects.toThrow('Failed to download image');
});

// å†…å®¹ç±»å‹éªŒè¯
test('should throw error for non-image content type', async () => {
  global.fetch = jest.fn().mockResolvedValue({
    ok: true,
    headers: new Map([['content-type', 'text/plain']]),
    arrayBuffer: async () => Buffer.from('text')
  });
  await expect(
    FileService.encodeImageToBase64('https://example.com/file.txt')
  ).rejects.toThrow('Invalid content type');
});

// å¤§å°éªŒè¯
test('should throw error for oversized online image', async () => {
  global.fetch = jest.fn().mockResolvedValue({
    ok: true,
    headers: new Map([
      ['content-type', 'image/jpeg'],
      ['content-length', '25165824'] // 24MB
    ]),
    arrayBuffer: async () => Buffer.alloc(25165824)
  });
  await expect(
    FileService.encodeImageToBase64('https://example.com/large.jpg')
  ).rejects.toThrow('Downloaded image too large');
});
```

**é›†æˆæµ‹è¯•**:
- æµ‹è¯•çœŸå®åœ¨çº¿å›¾ç‰‡ä¸‹è½½ï¼ˆä½¿ç”¨æµ‹è¯•å›¾ç‰‡ï¼‰
- æµ‹è¯•å„ç§ URL åœºæ™¯ï¼ˆHTTPã€HTTPSã€å¸¦è®¤è¯ç­‰ï¼‰
- æµ‹è¯•å¤§å›¾ç‰‡å¤„ç†ï¼ˆæ¥è¿‘ 20MB é™åˆ¶ï¼‰
- æµ‹è¯•ç½‘ç»œå¼‚å¸¸åœºæ™¯

### 10.7 æ€§èƒ½è€ƒè™‘

**ä¸‹è½½æ—¶é—´**:
- å°å›¾ç‰‡ï¼ˆ< 1MBï¼‰ï¼šé€šå¸¸ < 1 ç§’
- ä¸­ç­‰å›¾ç‰‡ï¼ˆ5MBï¼‰ï¼šé€šå¸¸ 2-3 ç§’
- å¤§å›¾ç‰‡ï¼ˆ20MBï¼‰ï¼šå¯èƒ½ 5-10 ç§’

**ä¼˜åŒ–å»ºè®®**:
1. æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆé¿å…é•¿æ—¶é—´ç­‰å¾…ï¼‰
2. å®ç°ä¸‹è½½è¿›åº¦åé¦ˆï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
3. è€ƒè™‘ç¼“å­˜æœºåˆ¶ï¼ˆé‡å¤å›¾ç‰‡ä¸é‡å¤ä¸‹è½½ï¼‰
4. æ”¯æŒå¹¶å‘ä¸‹è½½ï¼ˆæ‰¹é‡å¤„ç†ï¼‰

### 10.8 æœªæ¥ä¼˜åŒ–æ–¹å‘

**1. æ™ºèƒ½å‹ç¼©**:
```typescript
async function compressImage(imageBuffer: Buffer): Promise<Buffer> {
  // å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼Œè‡ªåŠ¨å‹ç¼©åˆ°åˆç†å°ºå¯¸
  if (imageBuffer.length > 5 * 1024 * 1024) {
    // ä½¿ç”¨ sharp æˆ–å…¶ä»–åº“å‹ç¼©
    return await sharp(imageBuffer)
      .resize(2048, 2048, { fit: 'inside' })
      .jpeg({ quality: 85 })
      .toBuffer();
  }
  return imageBuffer;
}
```

**2. æ ¼å¼è½¬æ¢**:
```typescript
// è‡ªåŠ¨è½¬æ¢ä¸ºæœ€ä¼˜æ ¼å¼ï¼ˆå¦‚ WebPï¼‰
async function convertToOptimalFormat(imageBuffer: Buffer, mimeType: string): Promise<string> {
  const webpBuffer = await sharp(imageBuffer)
    .webp({ quality: 85 })
    .toBuffer();

  return `data:image/webp;base64,${webpBuffer.toString('base64')}`;
}
```

**3. ç¼“å­˜æœºåˆ¶**:
```typescript
const imageCache = new LRUCache<string, string>({ max: 100, ttl: 3600000 });

async function getOrDownloadImage(imageUrl: string): Promise<string> {
  const cached = imageCache.get(imageUrl);
  if (cached) return cached;

  const encoded = await downloadAndEncodeImage(imageUrl);
  imageCache.set(imageUrl, encoded);
  return encoded;
}
```

**4. é‡è¯•æœºåˆ¶**:
```typescript
async function downloadWithRetry(
  imageUrl: string,
  maxRetries: number = 3
): Promise<string> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await downloadAndEncodeImage(imageUrl);
    } catch (error) {
      if (attempt === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
    }
  }
  throw new Error('Max retries exceeded');
}
```

### 10.9 æ€»ç»“

è¿™æ¬¡æ”¹è¿›æ˜¾è‘—æå‡äº†åœ¨çº¿é“¾æ¥å¤„ç†çš„å¯é æ€§å’Œç”¨æˆ·ä½“éªŒï¼š

1. **ä»ä¸å¯æ§åˆ°å¯æ§**ï¼šä¸ä¾èµ–å¤–éƒ¨æœåŠ¡çš„ç½‘ç»œèƒ½åŠ›
2. **ä»æ¨¡ç³Šåˆ°æ¸…æ™°**ï¼šé”™è¯¯ä¿¡æ¯æ˜ç¡®ï¼Œæ˜“äºè°ƒè¯•
3. **ä»è¢«åŠ¨åˆ°ä¸»åŠ¨**ï¼šæå‰éªŒè¯ï¼Œé¿å…æ— æ•ˆè¯·æ±‚
4. **ä»ç®€å•åˆ°å®Œå–„**ï¼šæ”¯æŒæ›´å¤šæ ¼å¼ï¼Œæ›´å¥½çš„é”™è¯¯å¤„ç†

è¿™äº›æ”¹è¿›ä½¿å¾— Vision MCP Server åœ¨å¤„ç†åœ¨çº¿å›¾ç‰‡æ—¶æ›´åŠ å¥å£®ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒã€‚

---

## åä¸€ã€åç»­ä¼˜åŒ–å»ºè®®

### 11.1 åŠŸèƒ½å¢å¼º

#### 1. å¤šæ¨¡å‹æ”¯æŒ

**ç›®æ ‡**: æ”¯æŒæ›´å¤š OpenAI å…¼å®¹çš„æ¨¡å‹ï¼ˆå¦‚ Anthropic Claude, Google Geminiï¼‰

**å®ç°**:
```javascript
// åœ¨ç¯å¢ƒé…ç½®ä¸­æ·»åŠ æ¨¡å‹æä¾›å•†
{
    MODEL_PROVIDER: "openai" | "anthropic" | "google",
    ANTHROPIC_API_KEY: string,
    GOOGLE_API_KEY: string
}
```

#### 2. ç»“æœç¼“å­˜

**ç›®æ ‡**: ç¼“å­˜ç›¸åŒå›¾åƒå’Œæç¤ºè¯çš„åˆ†æç»“æœï¼Œå‡å°‘ API è°ƒç”¨

**å®ç°**:
```javascript
// ä½¿ç”¨å†…å­˜æˆ– Redis ç¼“å­˜
import { LRUCache } from 'lru-cache';

const cache = new LRUCache({
    max: 100,
    ttl: 1000 * 60 * 60 // 1 hour
});

async function cachedVisionAnalysis(imageSource, prompt) {
    const key = `${imageSource}:${prompt}`;
    const cached = cache.get(key);
    if (cached) return cached;

    const result = await visionCompletions(messages);
    cache.set(key, result);
    return result;
}
```

#### 3. æ‰¹é‡å¤„ç†

**ç›®æ ‡**: æ”¯æŒæ‰¹é‡åˆ†æå¤šä¸ªå›¾åƒ

**å®ç°**:
```javascript
server.tool('batch_analyze_images', 'Analyze multiple images at once', {
    image_sources: z.array(z.string()).describe('Array of image paths or URLs'),
    prompt: z.string().describe('Analysis prompt')
}, async (params) => {
    const results = await Promise.all(
        params.image_sources.map(src => analyzeImage(src, params.prompt))
    );
    return formatMcpResponse(createSuccessResponse(results));
});
```

### 11.2 æ€§èƒ½ä¼˜åŒ–

#### 1. å›¾åƒå‹ç¼©

**ç›®æ ‡**: è‡ªåŠ¨å‹ç¼©è¿‡å¤§çš„å›¾åƒï¼Œå‡å°‘ä¼ è¾“å’Œ API è°ƒç”¨æˆæœ¬

**å®ç°**:
```javascript
import sharp from 'sharp';

async function compressImage(imagePath, maxSizeMB = 5) {
    const stats = fs.statSync(imagePath);
    if (stats.size <= maxSizeMB * 1024 * 1024) {
        return imagePath; // ä¸éœ€è¦å‹ç¼©
    }

    const compressedPath = imagePath + '.compressed.jpg';
    await sharp(imagePath)
        .jpeg({ quality: 80 })
        .resize(2048, 2048, { fit: 'inside' })
        .toFile(compressedPath);

    return compressedPath;
}
```

#### 2. æµå¼å“åº”ï¼ˆå·²éƒ¨åˆ†å®ç°ï¼‰

**ç›®æ ‡**: æ”¯æŒæµå¼å“åº”ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ

**å®ç°**:
```javascript
async visionCompletionsStream(messages, onChunk) {
    const response = await fetch(url, {
        method: 'POST',
        headers: { ... },
        body: JSON.stringify({ ... messages, stream: true })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n').filter(line => line.trim());

        for (const line of lines) {
            if (line.startsWith('data: ')) {
                const data = JSON.parse(line.slice(6));
                if (data.choices?.[0]?.delta?.content) {
                    onChunk(data.choices[0].delta.content);
                }
            }
        }
    }
}
```

### 10.3 ç›‘æ§å’Œæ—¥å¿—

#### 1. ä½¿ç”¨ç»Ÿè®¡

**ç›®æ ‡**: è®°å½• API ä½¿ç”¨æƒ…å†µï¼Œä¾¿äºæˆæœ¬åˆ†æ

**å®ç°**:
```javascript
class UsageTracker {
    private stats = {
        totalCalls: 0,
        totalTokens: 0,
        totalCost: 0,
        byTool: {} as Record<string, number>
    };

    track(toolName: string, tokens: number, cost: number) {
        this.stats.totalCalls++;
        this.stats.totalTokens += tokens;
        this.stats.totalCost += cost;
        this.stats.byTool[toolName] = (this.stats.byTool[toolName] || 0) + 1;
    }

    getStats() {
        return this.stats;
    }
}
```

#### 2. é”™è¯¯è¿½è¸ª

**ç›®æ ‡**: é›†æˆé”™è¯¯è¿½è¸ªæœåŠ¡ï¼ˆå¦‚ Sentryï¼‰

**å®ç°**:
```javascript
import * as Sentry from "@sentry/node";

Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV
});

async function trackError(error, context) {
    Sentry.captureException(error, {
        extra: context
    });
}
```

### 11.4 æµ‹è¯•æ”¹è¿›

#### 1. å¿«ç…§æµ‹è¯•

**ç›®æ ‡**: ç¡®ä¿å·¥å…·è¾“å‡ºæ ¼å¼çš„ä¸€è‡´æ€§

**å®ç°**:
```javascript
describe('Snapshot Tests', () => {
    test('ui_to_artifact should produce consistent output', async () => {
        const result = await callTool('ui_to_artifact', {
            image_source: './snapshot-ui.png',
            output_type: 'code',
            prompt: 'Generate code'
        });
        expect(result).toMatchSnapshot();
    });
});
```

#### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•

**ç›®æ ‡**: ç¡®ä¿æ€§èƒ½æ²¡æœ‰é€€åŒ–

**å®ç°**:
```javascript
import { performance } from 'perf_hooks';

describe('Performance Benchmarks', () => {
    test('should complete analysis within reasonable time', async () => {
        const start = performance.now();
        await analyzeImage('./test.png', 'Analyze this');
        const duration = performance.now() - start;

        expect(duration).toBeLessThan(10000); // 10 seconds
    });
});
```

---

## åäºŒã€æ€»ç»“

### 11.1 æ”¹é€ æˆæœ

æœ¬æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹æ”¹é€ ï¼ŒæˆåŠŸå°† code-rag/mcp-server è½¬æ¢ä¸ºåŸºäº OpenAI API çš„ Vision MCP Serverï¼š

1. âœ… **åŠŸèƒ½è£å‰ª**
   - ç§»é™¤äº†è§†é¢‘åˆ†æå·¥å…·
   - ç§»é™¤äº†æ‰€æœ‰è§†é¢‘ç›¸å…³çš„ä»£ç 
   - ä¿ç•™äº† 7 ä¸ªå›¾åƒåˆ†æå·¥å…·

2. âœ… **æ¥å£æ”¹é€ **
   - å°†æ™ºè°± API æ ¼å¼æ”¹é€ ä¸º OpenAI API æ ¼å¼
   - ç®€åŒ–äº†ç¯å¢ƒå˜é‡é…ç½®
   - æé«˜äº†æ¥å£å…¼å®¹æ€§

3. âœ… **æ¶æ„ä¿æŒ**
   - ä¿æŒäº†åŸæœ‰çš„ä¼˜ç§€æ¶æ„è®¾è®¡
   - ä¿æŒäº†ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
   - ä¿æŒäº†æ¨¡å—åŒ–è®¾è®¡

### 12.2 æŠ€æœ¯äº®ç‚¹

1. **æ¸…æ™°çš„æ¶æ„åˆ†å±‚**: æ ¸å¿ƒã€å·¥å…·ã€å·¥å…·å‡½æ•°ä¸‰å±‚æ¶æ„ï¼ŒèŒè´£æ¸…æ™°
2. **å®Œå–„çš„é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
3. **çµæ´»çš„é…ç½®ç³»ç»Ÿ**: æ”¯æŒå¤šç§ç¯å¢ƒå˜é‡é…ç½®
4. **å¼ºå¤§çš„å‚æ•°éªŒè¯**: ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶ç±»å‹éªŒè¯
5. **è‰¯å¥½çš„å¯æ‰©å±•æ€§**: åŸºäºç±»çš„ç»§æ‰¿æœºåˆ¶ï¼Œæ˜“äºæ·»åŠ æ–°å·¥å…·

### 11.3 é¡¹ç›®ä»·å€¼

1. **é™ä½ä½¿ç”¨é—¨æ§›**: ä½¿ç”¨æ ‡å‡†çš„ OpenAI APIï¼Œæ›´å®¹æ˜“è¢«å¹¿æ³›é‡‡ç”¨
2. **æé«˜å…¼å®¹æ€§**: OpenAI API æ˜¯äº‹å®æ ‡å‡†ï¼Œå…¼å®¹æ€§æ›´å¥½
3. **ç®€åŒ–é…ç½®**: å»é™¤äº†å¤æ‚çš„å¤šå¹³å°æ”¯æŒé€»è¾‘
4. **èšç„¦æ ¸å¿ƒåŠŸèƒ½**: ä¸“æ³¨äºå›¾åƒåˆ†æï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### 12.4 åç»­æ–¹å‘

1. **åŠŸèƒ½å¢å¼º**: æ·»åŠ å¤šæ¨¡å‹æ”¯æŒã€ç»“æœç¼“å­˜ã€æ‰¹é‡å¤„ç†
2. **æ€§èƒ½ä¼˜åŒ–**: å›¾åƒå‹ç¼©ã€æµå¼å“åº”ã€å¹¶è¡Œå¤„ç†
3. **ç›‘æ§å’Œæ—¥å¿—**: ä½¿ç”¨ç»Ÿè®¡ã€é”™è¯¯è¿½è¸ªã€æ€§èƒ½ç›‘æ§
4. **æµ‹è¯•æ”¹è¿›**: å¿«ç…§æµ‹è¯•ã€åŸºå‡†æµ‹è¯•ã€è¦†ç›–ç‡æå‡

---

## é™„å½•

### A. å®Œæ•´çš„ä»£ç ä¿®æ”¹å¯¹æ¯”

#### A.1 environment.ts ä¿®æ”¹å¯¹æ¯”

**æ—§ç‰ˆæœ¬** (æ™ºè°±):
```typescript
loadEnvironmentConfig() {
    const envConfig = { ...process.env };

    if (!envConfig.Z_AI_BASE_URL) {
        envConfig.Z_AI_BASE_URL = 'https://open.bigmodel.cn/api/paas/v4/';
    }

    if (envConfig.PLATFORM_MODE != null) {
        if (envConfig.PLATFORM_MODE === 'Z_AI' || ...) {
            envConfig.Z_AI_BASE_URL = 'https://api.z.ai/api/paas/v4/';
            envConfig.PLATFORM_MODE = 'ZAI';
        } else if (...) {
            envConfig.Z_AI_BASE_URL = 'https://open.bigmodel.cn/api/paas/v4/';
            envConfig.PLATFORM_MODE = 'ZHIPU';
        }
    } else {
        envConfig.PLATFORM_MODE = 'ZHIPU';
    }

    if (!envConfig.Z_AI_API_KEY && envConfig.ZAI_API_KEY) {
        envConfig.Z_AI_API_KEY = envConfig.ZAI_API_KEY;
    }

    if (!envConfig.Z_AI_API_KEY || envConfig.Z_AI_API_KEY?.toLowerCase().includes('api') || ...) {
        if (envConfig.ANTHROPIC_AUTH_TOKEN && !envConfig.ANTHROPIC_AUTH_TOKEN?.toLowerCase().includes('api')) {
            envConfig.Z_AI_API_KEY = envConfig.ANTHROPIC_AUTH_TOKEN;
        } else {
            throw new ApiError('Z_AI_API_KEY environment variable is required');
        }
    }

    return {
        Z_AI_BASE_URL: envConfig.Z_AI_BASE_URL,
        Z_AI_API_KEY: envConfig.Z_AI_API_KEY,
        Z_AI_VISION_MODEL: envConfig.Z_AI_VISION_MODEL || 'glm-4.6v',
        PLATFORM_MODE: envConfig.PLATFORM_MODE
        // ... å…¶ä»–é…ç½®
    };
}
```

**æ–°ç‰ˆæœ¬** (OpenAI):
```typescript
loadEnvironmentConfig() {
    const envConfig = { ...process.env };

    if (!envConfig.OPENAI_API_KEY || envConfig.OPENAI_API_KEY.trim().length === 0) {
        throw new ApiError('OPENAI_API_KEY environment variable is required');
    }

    const apiKey = envConfig.OPENAI_API_KEY;
    if (apiKey.toLowerCase().includes('your_') ||
        apiKey.toLowerCase().includes('api_key') ||
        apiKey.toLowerCase().includes('sk-')) {
        throw new ApiError('OPENAI_API_KEY appears to be a placeholder');
    }

    return {
        OPENAI_API_KEY: apiKey,
        OPENAI_BASE_URL: envConfig.OPENAI_BASE_URL || 'https://api.openai.com/v1',
        OPENAI_VISION_MODEL: envConfig.OPENAI_VISION_MODEL || 'gpt-4o',
        OPENAI_MODEL_TEMPERATURE: parseFloat(envConfig.OPENAI_MODEL_TEMPERATURE || '0.8'),
        OPENAI_MODEL_TOP_P: parseFloat(envConfig.OPENAI_MODEL_TOP_P || '0.6'),
        OPENAI_MODEL_MAX_TOKENS: parseInt(envConfig.OPENAI_MODEL_MAX_TOKENS || '32768'),
        OPENAI_TIMEOUT: parseInt(envConfig.OPENAI_TIMEOUT || '300000'),
        OPENAI_RETRY_COUNT: parseInt(envConfig.OPENAI_RETRY_COUNT || '1'),
        SERVER_NAME: envConfig.SERVER_NAME || 'vision-mcp-server',
        SERVER_VERSION: envConfig.SERVER_VERSION || '0.1.2'
    };
}
```

#### A.2 chat-service.ts ä¿®æ”¹å¯¹æ¯”

**æ—§ç‰ˆæœ¬** (æ™ºè°±):
```typescript
async visionCompletions(messages) {
    const visionConfig = configurationService.getVisionConfig();
    const requestBody = {
        model: visionConfig.model,
        messages,
        thinking: { type: 'enabled' },  // æ™ºè°±ç‰¹æœ‰
        stream: false,
        temperature: visionConfig.temperature,
        top_p: visionConfig.topP,
        max_tokens: visionConfig.maxTokens
    };

    const response = await this.chatCompletions(visionConfig.url, requestBody);
    return response.choices?.[0]?.message?.content;
}

async chatCompletions(url, body) {
    const apiKey = this.environmentService.getApiKey();
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'X-Title': '4.5V MCP Local',  // æ™ºè°±ç‰¹æœ‰
            'Accept-Language': 'en-US,en'
        },
        body: JSON.stringify(body)
    });
    // ...
}
```

**æ–°ç‰ˆæœ¬** (OpenAI):
```typescript
async visionCompletions(messages) {
    const visionConfig = configurationService.getVisionConfig();
    const apiKey = this.environmentService.getApiKey();

    const requestBody = {
        model: visionConfig.model,
        messages,
        temperature: visionConfig.temperature,
        top_p: visionConfig.topP,
        max_tokens: visionConfig.maxTokens,
        stream: false
    };

    console.info('Requesting OpenAI chat completions API', {
        model: visionConfig.model,
        messageCount: messages.length
    });

    try {
        const response = await this.chatCompletions(visionConfig.url, requestBody, apiKey);
        const result = response.choices?.[0]?.message?.content;
        if (!result) {
            throw new ApiError('Invalid API response: missing content');
        }
        console.info('OpenAI chat completions API request successful');
        return result;
    } catch (error) {
        console.error('OpenAI chat completions API request failed', {
            error: error instanceof Error ? error.message : String(error)
        });
        throw error instanceof ApiError ? error : new ApiError(`API call failed: ${error}`);
    }
}

async chatCompletions(url, body, apiKey) {
    const apiConfig = configurationService.getVisionConfig();
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), apiConfig.timeout);

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(body),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorText = await response.text();
            throw new ApiError(`HTTP ${response.status}: ${errorText}`);
        }

        return await response.json();
    } catch (error) {
        clearTimeout(timeoutId);
        if (error instanceof ApiError) {
            throw error;
        }
        if (error instanceof Error) {
            if (error.name === 'AbortError') {
                throw new ApiError(`Request timeout after ${apiConfig.timeout}ms`);
            }
            if (error.message.includes('fetch failed')) {
                throw new ApiError(`Network error: Failed to connect to ${url}`);
            }
            throw new ApiError(`Network error: ${error.message}`);
        }
        throw new ApiError(`Network error: ${String(error)}`);
    }
}
```

### B. ç¯å¢ƒå˜é‡å¯¹ç…§è¡¨

| æ™ºè°±é…ç½® | OpenAI é…ç½® | è¯´æ˜ |
|---------|------------|------|
| Z_AI_API_KEY | OPENAI_API_KEY | API å¯†é’¥ |
| Z_AI_BASE_URL | OPENAI_BASE_URL | API åŸºç¡€ URL |
| Z_AI_VISION_MODEL | OPENAI_VISION_MODEL | è§†è§‰æ¨¡å‹åç§° |
| Z_AI_VISION_MODEL_TEMPERATURE | OPENAI_MODEL_TEMPERATURE | æ¸©åº¦å‚æ•° |
| Z_AI_VISION_MODEL_TOP_P | OPENAI_MODEL_TOP_P | Top P å‚æ•° |
| Z_AI_VISION_MODEL_MAX_TOKENS | OPENAI_MODEL_MAX_TOKENS | æœ€å¤§ tokens |
| Z_AI_TIMEOUT | OPENAI_TIMEOUT | è¶…æ—¶æ—¶é—´ |
| Z_AI_RETRY_COUNT | OPENAI_RETRY_COUNT | é‡è¯•æ¬¡æ•° |
| PLATFORM_MODE | - | å¹³å°æ¨¡å¼ï¼ˆå·²åˆ é™¤ï¼‰ |
| ZAI_API_KEY | - | å…¼å®¹å˜é‡ï¼ˆå·²åˆ é™¤ï¼‰ |
| ANTHROPIC_AUTH_TOKEN | - | å…¼å®¹å˜é‡ï¼ˆå·²åˆ é™¤ï¼‰ |

### C. æ”¯æŒçš„æ¨¡å‹å¯¹ç…§è¡¨

| æ™ºè°±æ¨¡å‹ | OpenAI æ¨¡å‹ | èƒ½åŠ› | æ¨è |
|---------|------------|------|------|
| glm-4.6v | gpt-4o | æœ€æ–°çš„å¤šæ¨¡æ€æ¨¡å‹ | âœ… æ¨è |
| glm-4v | gpt-4o-mini | è½»é‡çº§å¤šæ¨¡æ€æ¨¡å‹ | âœ… æ€§ä»·æ¯”é«˜ |
| - | gpt-4-turbo | é«˜æ€§èƒ½å¤šæ¨¡æ€æ¨¡å‹ | âœ… æ€§èƒ½ä¼˜å…ˆ |
| - | gpt-4-vision-preview | è§†è§‰é¢„è§ˆç‰ˆ | âš ï¸ æµ‹è¯•ç”¨ |

### D. å¸¸è§é—®é¢˜ FAQ

**Q1: ä¸ºä»€ä¹ˆè¦ç§»é™¤è§†é¢‘åŠŸèƒ½ï¼Ÿ**
A: è§†é¢‘åŠŸèƒ½ä½¿ç”¨é¢‘ç‡è¾ƒä½ï¼Œä¸” OpenAI API çš„è§†é¢‘æ”¯æŒèƒ½åŠ›æœ‰é™ã€‚ç§»é™¤è§†é¢‘åŠŸèƒ½å¯ä»¥ç®€åŒ–ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€‚

**Q2: ä»æ™ºè°±è¿ç§»åˆ° OpenAI æˆæœ¬ä¼šå¢åŠ å—ï¼Ÿ**
A: å¯èƒ½ä¼šå¢åŠ ã€‚å»ºè®®é»˜è®¤ä½¿ç”¨ `gpt-4o-mini` æ¨¡å‹æ¥é™ä½æˆæœ¬ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¨¡å‹ã€‚

**Q3: æˆ‘å¯ä»¥ä½¿ç”¨å…¶ä»– OpenAI å…¼å®¹çš„ API å—ï¼Ÿ**
A: å¯ä»¥ï¼é€šè¿‡è®¾ç½® `OPENAI_BASE_URL` ç¯å¢ƒå˜é‡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•å…¼å®¹ OpenAI API æ ¼å¼çš„æœåŠ¡ã€‚

**Q4: æ”¯æŒçš„å›¾åƒæ ¼å¼æœ‰å“ªäº›ï¼Ÿ**
A: æ”¯æŒ PNGã€JPGã€JPEG æ ¼å¼ï¼Œæœ€å¤§æ–‡ä»¶å¤§å°ä¸º 20MBã€‚

**Q5: å¦‚ä½•æé«˜å›¾åƒåˆ†æé€Ÿåº¦ï¼Ÿ**
A: 1) ä½¿ç”¨ `gpt-4o-mini` æ¨¡å‹ï¼›2) å‹ç¼©å›¾åƒå¤§å°ï¼›3) å‡å°å›¾ç‰‡å°ºå¯¸ã€‚

**Q6: ä½¿ç”¨åœ¨çº¿å›¾ç‰‡é“¾æ¥æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ**
A: 1) å¯ä»¥è®¿é—®äº’è”ç½‘ä¸Šçš„ä»»ä½•å…¬å¼€å›¾ç‰‡ï¼›2) æ–¹ä¾¿åˆ†äº«å’Œæµ‹è¯•ï¼›3) ä¸éœ€è¦æ‰‹åŠ¨ä¸‹è½½å›¾ç‰‡ï¼›4) ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸‹è½½å¹¶è½¬æ¢ä¸º base64ï¼Œç¡®ä¿å¯é æ€§ã€‚

**Q7: åœ¨çº¿å›¾ç‰‡é“¾æ¥ä¼šå¤±è´¥å—ï¼Ÿ**
A: å¯èƒ½ä¼šï¼Œä½†ç³»ç»Ÿä¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š
- å¦‚æœé“¾æ¥å¤±æ•ˆï¼ˆ404ï¼‰ï¼Œä¼šæç¤º"Failed to download image: HTTP 404"
- å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼Œä¼šæç¤ºå®é™…å¤§å°å’Œé™åˆ¶
- å¦‚æœå†…å®¹ç±»å‹é”™è¯¯ï¼Œä¼šæç¤ºæœŸæœ›çš„ç±»å‹
- å¦‚æœç½‘ç»œé—®é¢˜ï¼Œä¼šæç¤ºå…·ä½“çš„ç½‘ç»œé”™è¯¯

**Q8: ä¸ºä»€ä¹ˆä¸å†ç›´æ¥ä¼  URL ç»™ OpenAIï¼Ÿ**
A: ç›´æ¥ä¼  URL å­˜åœ¨é—®é¢˜ï¼š
1. OpenAI æœåŠ¡å™¨å¯èƒ½æ— æ³•è®¿é—®å†…ç½‘ã€ç§æœ‰äº‘æˆ–éœ€è¦è®¤è¯çš„é“¾æ¥
2. é“¾æ¥å¯èƒ½è¿‡æœŸæˆ–è¢«åˆ é™¤
3. æ— æ³•é¢„å¤„ç†å›¾ç‰‡ï¼ˆå‹ç¼©ã€æ ¼å¼è½¬æ¢ï¼‰
4. å¤±è´¥æ—¶éš¾ä»¥æ’æŸ¥é—®é¢˜
ç°åœ¨çš„å®ç°ä¼šå…ˆä¸‹è½½å›¾ç‰‡ï¼Œè½¬æ¢ä¸º base64ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå¯æ§æ€§ã€‚

**Q9: æ”¯æŒå“ªäº›å›¾ç‰‡æ ¼å¼ï¼Ÿ**
A: æœ¬åœ°æ–‡ä»¶æ”¯æŒï¼šPNGã€JPGã€JPEG
åœ¨çº¿ä¸‹è½½æ”¯æŒï¼šæ ¹æ®å“åº”çš„ Content-Type è‡ªåŠ¨è¯†åˆ«ï¼Œæ”¯æŒ image/pngã€image/jpegã€image/webpã€image/gif ç­‰æ ‡å‡†å›¾ç‰‡æ ¼å¼ã€‚

**Q10: å‡ºç° "API key appears to be a placeholder" é”™è¯¯æ€ä¹ˆåŠï¼Ÿ**
A: è¯·æ£€æŸ¥ `OPENAI_API_KEY` ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ä½¿ç”¨çœŸå®çš„ API Keyï¼Œè€Œä¸æ˜¯å ä½ç¬¦å¦‚ "your_api_key"ã€‚

**Q7: å¦‚ä½•è°ƒè¯•é—®é¢˜ï¼Ÿ**
A: æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `~/.vision/vision-mcp-YYYY-MM-DD.log`ï¼Œæˆ–åœ¨å¯åŠ¨æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ `VISION_MCP_LOG_LEVEL=debug`ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-15
**ä½œè€…**: CodeBuddy Code
**é¡¹ç›®**: Vision MCP Server
